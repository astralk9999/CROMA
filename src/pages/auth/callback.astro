---
import PublicLayout from "@layouts/PublicLayout.astro";
import BrandLogo from "@components/BrandLogo.astro";
import { supabase } from "@lib/supabase";

// Server-side check for PKCE code
const authCode = Astro.url.searchParams.get("code");
const nextParam = Astro.url.searchParams.get("next");
const nextCookie = Astro.cookies.get("sb-redirect-next")?.value;
const next = nextParam || nextCookie || "/account/profile";

if (authCode) {
    try {
        const { data, error } = await supabase.auth.exchangeCodeForSession(authCode);
        if (error) throw error;
        
        if (data.session) {
            Astro.cookies.set("sb-access-token", data.session.access_token, { path: "/", sameSite: "lax", secure: import.meta.env.PROD });
            Astro.cookies.set("sb-refresh-token", data.session.refresh_token, { path: "/", sameSite: "lax", secure: import.meta.env.PROD });
            Astro.cookies.delete("sb-redirect-next", { path: "/" });
            return Astro.redirect(next);
        }
    } catch (e: any) {
        console.error("Server-side auth exchange error:", e);
        // Don't return yet, let the client-side script try to handle hash-based fallback or show error
    }
}
---

<PublicLayout title="Verificando Acceso - CROMA">
    <section class="min-h-[80vh] flex items-center justify-center bg-white py-12 px-4">
        <div class="max-w-md w-full text-center">
            <!-- Premium Loading Animation -->
            <div class="relative w-24 h-24 mx-auto mb-8">
                <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-black rounded-full animate-spin border-t-transparent shadow-lg"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <BrandLogo class="w-12 h-12 text-black" />
                </div>
            </div>

            <h1 class="text-3xl font-black uppercase tracking-tighter text-gray-900 mb-4 animate-pulse">
                Validando acceso
            </h1>
            
            <div class="space-y-3">
                <p class="text-gray-500 font-medium">Estamos verificando tu identidad de forma segura...</p>
                <div class="flex justify-center gap-1">
                    <div class="w-1.5 h-1.5 bg-black rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-1.5 h-1.5 bg-black rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-1.5 h-1.5 bg-black rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>

            <div id="error-display" class="hidden mt-8 p-4 bg-red-50 border-l-4 border-red-500 rounded text-left">
                <p class="text-red-700 text-sm font-bold uppercase tracking-wider mb-1">¡Vaya! Algo ha fallado</p>
                <p id="error-message" class="text-red-600 text-sm"></p>
                <a href="/auth/login" class="inline-block mt-4 text-black font-black underline text-sm uppercase">Volver al inicio</a>
            </div>
        </div>
    </section>

    <script>
        import { supabase } from "@lib/supabase";

        let retries = 0;
        async function handleAuth() {
            try {
                // 1. Check for URL error parameters
                const params = new URLSearchParams(window.location.search);
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                
                const errorDescription = params.get('error_description') || hashParams.get('error_description');
                if (errorDescription) {
                    throw new Error(errorDescription);
                }

                // 2. Look for sessions
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    // If it's an abort error, retry once after a delay
                    if (error.name === 'AbortError' && retries < 1) {
                        retries++;
                        setTimeout(handleAuth, 1000);
                        return;
                    }
                    throw error;
                }

                if (session) {
                    const isSecure = window.location.protocol === 'https:';
                    document.cookie = `sb-access-token=${session.access_token}; path=/; max-age=604800; SameSite=Lax; ${isSecure ? 'Secure;' : ''}`;
                    document.cookie = `sb-refresh-token=${session.refresh_token}; path=/; max-age=604800; SameSite=Lax; ${isSecure ? 'Secure;' : ''}`;
                    
                    const nextMatch = document.cookie.match(/sb-redirect-next=([^;]+)/);
                    const next = nextMatch ? decodeURIComponent(nextMatch[1]) : "/account/profile";
                    
                    document.cookie = "sb-redirect-next=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
                    
                    // Small delay to ensure cookies are written before redirect
                    setTimeout(() => { window.location.href = next; }, 100);
                } else {
                    // If no session yet, wait bit for background processing
                    if ((params.has('code') || window.location.hash.includes('access_token')) && retries < 2) {
                         retries++;
                         setTimeout(handleAuth, 1500);
                    } else {
                         showError('No se ha encontrado una sesión válida. Por favor, intenta iniciar sesión de nuevo.');
                    }
                }
            } catch (err: any) {
                console.error("Auth process failed:", err);
                if (err.name === 'AbortError') {
                    // Silent retry for aborts
                    if (retries < 1) {
                        retries++;
                        setTimeout(handleAuth, 1000);
                    }
                } else {
                    showError(err.message || 'Error inesperado durante la autenticación');
                }
            }
        }

        function showError(msg: string) {
            const errorDisplay = document.getElementById('error-display');
            const errorMessageElement = document.getElementById('error-message');
            
            if (errorDisplay && errorMessageElement) {
                errorMessageElement.textContent = msg;
                errorDisplay.classList.remove('hidden');
                document.querySelector('h1')?.classList.add('hidden');
                document.querySelector('.relative.w-24')?.classList.add('hidden');
                document.querySelector('.space-y-3')?.classList.add('hidden');
            } else {
                window.location.href = `/auth/login?error=${encodeURIComponent(msg)}`;
            }
        }

        // Start immediately but wait for DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', handleAuth);
        } else {
            handleAuth();
        }
    </script>
</PublicLayout>
