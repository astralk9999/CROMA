---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import ImageUploader from '@components/islands/ImageUploader';
import { supabase } from '@lib/supabase';
import { generateSlug } from '@lib/utils';

const { data: categories } = await supabase
  .from('categories')
  .select('*');

let error = '';
let success = false;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const name = formData.get('name')?.toString();
    const description = formData.get('description')?.toString();
    const price = formData.get('price')?.toString();
    const stock = formData.get('stock')?.toString();
    const categoryId = formData.get('category_id')?.toString();
    const sizes = formData.get('sizes')?.toString();
    const featured = formData.get('featured') === 'on';
    const images = formData.get('images')?.toString();

    if (!name || !price || !stock) {
      error = 'Por favor, completa todos los campos obligatorios.';
    } else {
      const slug = generateSlug(name);
      const priceInCents = Math.round(parseFloat(price) * 100);
      const stockNumber = parseInt(stock);
      const sizesArray = sizes ? sizes.split(',').map(s => s.trim()) : [];
      const imagesArray = images ? JSON.parse(images) : [];

      const { error: insertError } = await supabase
        .from('products')
        .insert({
          name,
          slug,
          description,
          price: priceInCents,
          stock: stockNumber,
          category_id: categoryId || null,
          sizes: sizesArray,
          images: imagesArray,
          featured,
        });

      if (insertError) {
        error = `Error al crear el producto: ${insertError.message}`;
      } else {
        success = true;
        return Astro.redirect('/admin/productos');
      }
    }
  } catch (e) {
    error = 'Error al procesar el formulario.';
  }
}
---

<AdminLayout title="Nuevo Producto">
  <div class="max-w-4xl">
    <div class="mb-8">
      <h1 class="text-4xl font-serif font-bold text-navy-900 mb-2">Nuevo Producto</h1>
      <p class="text-charcoal-600">Completa el formulario para añadir un nuevo producto al catálogo.</p>
    </div>

    {error && (
      <div class="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
        {error}
      </div>
    )}

    <form method="POST" class="bg-white rounded-lg shadow-sm border border-charcoal-200 p-8 space-y-6">
      {/* Basic Info */}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="md:col-span-2">
          <label for="name" class="block text-sm font-medium text-charcoal-700 mb-2">
            Nombre del Producto *
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full px-4 py-2 border border-charcoal-300 rounded-md focus:outline-none focus:ring-2 focus:ring-navy-600"
            placeholder="Ej: Camisa Oxford Azul"
          />
        </div>

        <div>
          <label for="price" class="block text-sm font-medium text-charcoal-700 mb-2">
            Precio (€) *
          </label>
          <input
            type="number"
            id="price"
            name="price"
            step="0.01"
            min="0"
            required
            class="w-full px-4 py-2 border border-charcoal-300 rounded-md focus:outline-none focus:ring-2 focus:ring-navy-600"
            placeholder="99.99"
          />
        </div>

        <div>
          <label for="stock" class="block text-sm font-medium text-charcoal-700 mb-2">
            Stock *
          </label>
          <input
            type="number"
            id="stock"
            name="stock"
            min="0"
            required
            class="w-full px-4 py-2 border border-charcoal-300 rounded-md focus:outline-none focus:ring-2 focus:ring-navy-600"
            placeholder="10"
          />
        </div>

        <div>
          <label for="category_id" class="block text-sm font-medium text-charcoal-700 mb-2">
            Categoría
          </label>
          <select
            id="category_id"
            name="category_id"
            class="w-full px-4 py-2 border border-charcoal-300 rounded-md focus:outline-none focus:ring-2 focus:ring-navy-600"
          >
            <option value="">Sin categoría</option>
            {categories?.map((cat) => (
              <option value={cat.id}>{cat.name}</option>
            ))}
          </select>
        </div>

        <div>
          <label for="sizes" class="block text-sm font-medium text-charcoal-700 mb-2">
            Tallas (separadas por comas)
          </label>
          <input
            type="text"
            id="sizes"
            name="sizes"
            class="w-full px-4 py-2 border border-charcoal-300 rounded-md focus:outline-none focus:ring-2 focus:ring-navy-600"
            placeholder="S, M, L, XL"
          />
        </div>
      </div>

      {/* Description */}
      <div>
        <label for="description" class="block text-sm font-medium text-charcoal-700 mb-2">
          Descripción
        </label>
        <textarea
          id="description"
          name="description"
          rows="4"
          class="w-full px-4 py-2 border border-charcoal-300 rounded-md focus:outline-none focus:ring-2 focus:ring-navy-600"
          placeholder="Describe las características del producto..."
        ></textarea>
      </div>

      {/* Images */}
      <div>
        <label class="block text-sm font-medium text-charcoal-700 mb-2">
          Imágenes del Producto
        </label>
        <input type="hidden" id="images" name="images" value="[]" />
        <ImageUploader 
          client:load
          onImagesSelected={(files) => {
            console.log('Selected files:', files);
          }}
        />
        <p class="mt-2 text-sm text-charcoal-500">
          Nota: La subida de imágenes a Supabase Storage se implementará en el siguiente paso.
        </p>
      </div>

      {/* Featured */}
      <div class="flex items-center">
        <input
          type="checkbox"
          id="featured"
          name="featured"
          class="h-4 w-4 text-navy-800 focus:ring-navy-600 border-charcoal-300 rounded"
        />
        <label for="featured" class="ml-2 text-sm text-charcoal-700">
          Marcar como producto destacado
        </label>
      </div>

      {/* Actions */}
      <div class="flex items-center gap-4 pt-4">
        <button
          type="submit"
          class="px-6 py-3 bg-navy-800 text-white font-semibold rounded hover:bg-navy-900 transition-colors"
        >
          Crear Producto
        </button>
        <a
          href="/admin/productos"
          class="px-6 py-3 border border-charcoal-300 text-charcoal-700 font-medium rounded hover:bg-cream-100 transition-colors"
        >
          Cancelar
        </a>
      </div>
    </form>
  </div>
</AdminLayout>
