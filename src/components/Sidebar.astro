---
import { supabase } from '../lib/supabase';

// 1. Fetch Categories
const { data: categories } = await supabase
  .from('categories')
  .select('name, slug')
  .order('name');

const safeCategories = categories || [];

// 2. Fetch Brands
const { data: brands } = await supabase
  .from('brands')
  .select('name, slug')
  .order('name');

const safeBrands = brands || [];

// 3. Fetch Colors from master table
const { data: colorsList } = await supabase
  .from('colors')
  .select('*')
  .order('name');

const uniqueColors = (colorsList || []).map(color => ({
    name: color.name,
    slug: color.slug,
    cssColor: color.hex_code || color.name.toLowerCase()
}));

// 4. Specials (Hardcoded)
const specials = [
   { name: 'LIMITED DROPS', slug: 'limited-drops' },
   { name: 'DISCOUNTS', slug: 'discounts' },
   { name: 'PRÓXIMOS LANZAMIENTOS', slug: 'coming-soon' },
   { name: 'TENDENCIAS VIRALES', slug: 'viral-trends' },
   { name: 'BESTSELLERS', slug: 'bestsellers' },
   { name: 'MY FAVORITES', slug: 'my-favorites' }
];
---

<aside class="w-68 flex-shrink-0 pl-3 pr-10 hidden lg:block" transition:persist>
  <div id="sidebar-scroll-container" class="sticky top-24 overflow-y-auto max-h-[calc(100vh-6rem)] custom-scrollbar py-4 pr-4">
    
    {/* Urban Access Card */}
    <div class="mb-12">
        <a href="/category/all" 
           class="group relative flex items-center justify-between overflow-hidden bg-black text-white p-5 rounded-[1.8rem] transition-all duration-300 hover:bg-zinc-900 border border-white/5 active:scale-[0.98]">
           
           <div class="absolute left-4 top-1/2 -translate-y-1/2 w-1 h-7 bg-white rounded-full transition-all duration-500 group-hover:h-9 group-hover:bg-zinc-400"></div>
           
           <div class="relative z-10 pl-5">
               <div class="flex items-center gap-2 mb-1">
                   <span class="text-[6.5px] font-mono text-zinc-500 uppercase tracking-[0.3em] group-hover:text-white transition-colors">PROTOCOL_ALL.ACCESS</span>
                   <div class="w-1 h-1 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.5)]"></div>
               </div>
               <h2 class="text-[17.5px] font-black uppercase tracking-tighter leading-none">
                   EVERYTHING / <span class="text-zinc-600 group-hover:text-white transition-colors">ALL</span>
               </h2>
           </div>

           <div class="relative z-10 w-9 h-9 rounded-full bg-white/5 border border-white/10 flex items-center justify-center group-hover:bg-white group-hover:text-black transition-all duration-500">
               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
           </div>
           
           <div class="absolute inset-0 bg-[#202020]"></div>
        </a>
    </div>

    {/* Section: Specials */}
    <div class="mb-12">
      <h3 class="font-urban font-black text-2xl uppercase mb-6 flex items-center text-gray-900 border-b-2 border-gray-900 pb-2">
         <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
         Specials
      </h3>
      <ul class="space-y-4 px-1">
        {specials.map(item => (
          <li>
            <a href={`/category/${item.slug}`} 
               class="group flex items-center text-[10.5px] font-black text-zinc-400 hover:text-black transition-all duration-300 uppercase tracking-widest">
               {item.name === 'MY FAVORITES' ? (
                 <svg class="w-3.5 h-3.5 mr-3 text-zinc-300 group-hover:text-red-500 transition-colors duration-300" fill="currentColor" viewBox="0 0 24 24">
                   <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"></path>
                 </svg>
               ) : (
                 <span class="w-2 h-2 rounded-full bg-zinc-200 group-hover:bg-black mr-4 transition-all group-hover:scale-125"></span>
               )}
               {item.name}
            </a>
          </li>
        ))}
      </ul>
    </div>

    {/* Section: Categories */}
    <div class="mb-12">
      <h3 class="font-urban font-black text-2xl uppercase mb-6 flex items-center text-gray-900 border-b-2 border-gray-900 pb-2">
         <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
         Categories
      </h3>
      <ul class="space-y-4">
        {safeCategories.map(item => (
          <li>
            <a href={`/category/${item.slug}`} 
               class="group flex items-center text-[10.5px] font-black text-zinc-400 hover:text-black transition-all duration-300 uppercase tracking-widest px-1">
               <svg class="w-3.5 h-3.5 mr-4 text-zinc-200 group-hover:text-black transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
               <span>{item.name}</span>
            </a>
          </li>
        ))}
        {safeCategories.length === 0 && (
            <li class="text-[9px] text-zinc-300 italic px-1">No categories found</li>
        )}
      </ul>
    </div>

    {/* Section: Brands */}
    <div class="mb-12">
      <h3 class="font-urban font-black text-2xl uppercase mb-6 flex items-center text-gray-900 border-b-2 border-gray-900 pb-2">
         <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
         Brands
      </h3>
      <ul class="space-y-4 px-1">
        {safeBrands.map(item => (
          <li>
            <a href={`/brand/${item.slug}`} 
               class="group flex items-center text-[10.5px] font-black text-zinc-400 hover:text-black transition-all duration-300 uppercase tracking-widest">
               <span class="w-2 h-2 rounded-full bg-zinc-200 group-hover:bg-black mr-4 transition-all group-hover:scale-125"></span>
               {item.name}
            </a>
          </li>
        ))}
         {safeBrands.length === 0 && (
            <li class="text-[9px] text-zinc-300 italic px-1">No brands found</li>
        )}
      </ul>
    </div>

    {/* Section: Colors */}
    <div class="mb-24">
      <h3 class="font-urban font-black text-2xl uppercase mb-6 flex items-center text-gray-900 border-b-2 border-gray-900 pb-2">
         <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>
         Cromatografía
      </h3>
      <ul class="space-y-4 px-1">
        {uniqueColors.map(item => (
          <li>
             <a href={`/color/${item.slug}`} 
               class="group flex items-center text-[10.5px] font-black text-zinc-400 hover:text-black transition-all duration-300 uppercase tracking-widest">
               <div class="relative mr-4 overflow-hidden rounded-full p-[1.5px] bg-zinc-100 ring-1 ring-black/[0.1]">
                   <div class="w-3.5 h-3.5 rounded-full transition-transform group-hover:scale-110 shadow-inner" style={`background-color: ${item.cssColor};`}></div>
               </div>
               {item.name}
            </a>
          </li>
        ))}
        {uniqueColors.length === 0 && (
            <li class="text-[9px] text-zinc-300 italic px-1">No colors found</li>
        )}
      </ul>
    </div>

  </div>
<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 3px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #e4e4e7; /* zinc-200 */
    border-radius: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #18181b; /* zinc-900 */
  }
</style>
</aside>

<script>
  // Preserve scroll position of the sidebar across navigations
  function setupSidebarScroll() {
    const container = document.getElementById('sidebar-scroll-container');
    if (!container) return;

    // Restore position
    const savedScrollPos = sessionStorage.getItem('sidebar-scroll-pos');
    if (savedScrollPos) {
      container.scrollTop = parseInt(savedScrollPos, 10);
    }

    // Save position on scroll
    container.addEventListener('scroll', () => {
      sessionStorage.setItem('sidebar-scroll-pos', container.scrollTop.toString());
    }, { passive: true });
  }

  // Run on initial load
  setupSidebarScroll();

  // Run on View Transitions (if enabled)
  document.addEventListener('astro:after-swap', setupSidebarScroll);
</script>
