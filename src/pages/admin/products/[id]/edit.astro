---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

const user = Astro.locals.user;
const profile = Astro.locals.profile;

if (!user || profile?.role !== 'admin') {
  return Astro.redirect('/auth/login');
}

const { id } = Astro.params;

// Fetch product to edit
const { data: product, error } = await supabase
  .from('products')
  .select('*')
  .eq('id', id)
  .single();

if (error || !product) {
  return Astro.redirect('/admin/products');
}

// Fetch categories and brands
const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .order('name');

const { data: brands } = await supabase
  .from('brands')
  .select('*')
  .order('name');

const { data: allColors } = await supabase
  .from('colors')
  .select('*')
  .order('name');

const colorsMasterList = allColors || [];

// Format datetime for input (YYYY-MM-DDTHH:mm)
const formatDateTime = (dateString: string | null) => {
  if (!dateString) return '';
  return new Date(dateString).toISOString().slice(0, 16);
};
---

<AdminLayout title="Modificación de Registro" activeSection="products">
  <div class="max-w-5xl mx-auto">
    <!-- Header Section -->
    <div class="mb-12 flex flex-col md:flex-row md:items-end justify-between gap-6 px-4">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <span class="text-[9px] font-black text-black bg-zinc-100 px-2 py-0.5 rounded border border-black/5 tracking-widest uppercase">ID: {product.id.slice(0, 8)}</span>
                <span class="w-1 h-1 bg-zinc-200 rounded-full"></span>
                <span class="text-[9px] font-black text-zinc-400 uppercase tracking-widest">Procedencia: Local</span>
            </div>
            <h2 class="text-3xl font-black tracking-tighter text-black uppercase">Editar Registro</h2>
            <p class="text-[10px] font-bold text-zinc-400 uppercase tracking-[0.3em] mt-2 italic">Reconfiguración de parámetros comerciales</p>
        </div>
        <a href="/admin/products" class="group flex items-center gap-3 text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-black transition-colors">
            <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
            Volver al Depósito
        </a>
    </div>

    <form id="edit-product-form" class="space-y-10 mb-20" onsubmit="event.preventDefault(); return false;">
        <input type="hidden" name="id" value={product.id} />
        <input type="hidden" id="initial-images" value={JSON.stringify(product.images || [])} />

        <!-- Section 1: Identity -->
        <div class="bg-white rounded-2xl border border-black/5 shadow-sm p-10 md:p-12 relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-64 h-64 bg-zinc-50 rounded-full translate-x-1/2 -translate-y-1/2 -z-0 opacity-50"></div>
            
            <div class="relative z-10">
                <div class="flex items-center gap-4 mb-10">
                    <span class="w-10 h-10 bg-zinc-700 text-white rounded-lg flex items-center justify-center font-black text-xs shadow-xl">01</span>
                    <h3 class="text-xl font-black tracking-tighter uppercase text-black">Identidad del Producto</h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="md:col-span-2 space-y-3">
                        <label for="name" class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4 flex items-center gap-2">
                             Denominación Comercial <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="name" name="name" required value={product.name}
                            class="w-full bg-zinc-50 border-2 border-black/[0.03] rounded-xl px-8 py-5 text-sm font-black uppercase tracking-tight focus:outline-none focus:border-black focus:bg-white transition-all placeholder:text-zinc-200 shadow-inner" />
                    </div>

                    <div class="md:col-span-2 space-y-3">
                        <label for="description" class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4">Especificaciones Técnicas</label>
                        <textarea id="description" name="description" rows="4" 
                            class="w-full bg-zinc-50 border-2 border-black/[0.03] rounded-xl px-8 py-6 text-sm font-medium focus:outline-none focus:border-black focus:bg-white transition-all placeholder:text-zinc-200">{product.description}</textarea>
                    </div>

                    <div class="space-y-3">
                        <label for="price" class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4">Valoración Base (€) <span class="text-red-500">*</span></label>
                        <input type="number" id="price" name="price" required step="0.01" min="0" value={product.price}
                            class="w-full bg-zinc-50 border-2 border-black/[0.03] rounded-xl px-8 py-5 text-sm font-black tracking-tight focus:outline-none focus:border-black focus:bg-white transition-all shadow-inner" />
                    </div>

                    <div class="space-y-3">
                       <label class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4">Sector / Categoría <span class="text-red-500">*</span></label>
                       <div class="relative">
                            <select name="category" required 
                                class="w-full bg-zinc-50 border-2 border-black/[0.03] rounded-xl px-8 py-5 text-[10px] font-black uppercase tracking-widest focus:outline-none focus:border-black focus:bg-white transition-all appearance-none cursor-pointer">
                                <option value="">NO ASIGNADO</option>
                                {categories?.map(cat => (
                                    <option value={cat.name} selected={product.category === cat.name}>{cat.name?.toUpperCase()}</option>
                                ))}
                            </select>
                            <svg class="absolute right-6 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"/></svg>
                       </div>
                    </div>

                    <div class="space-y-3">
                       <label class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4">Corporación / Marca <span class="text-red-500">*</span></label>
                       <div class="relative">
                            <select name="brand" required 
                                class="w-full bg-zinc-50 border-2 border-black/[0.03] rounded-xl px-8 py-5 text-[10px] font-black uppercase tracking-widest focus:outline-none focus:border-black focus:bg-white transition-all appearance-none cursor-pointer">
                                <option value="">NO ASIGNADO</option>
                                {brands?.map(brand => (
                                    <option value={brand.name} selected={product.brand === brand.name}>{brand.name?.toUpperCase()}</option>
                                ))}
                            </select>
                            <svg class="absolute right-6 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"/></svg>
                       </div>
                    </div>

                    <div class="flex items-center gap-6 px-4">
                        <label class="relative inline-flex items-center cursor-pointer group/toggle">
                            <input type="checkbox" name="featured" class="sr-only peer" checked={product.featured} />
                            <div class="w-14 h-8 bg-zinc-100 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-zinc-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-zinc-800"></div>
                            <span class="ml-4 text-[10px] font-black text-zinc-400 uppercase tracking-widest group-checked/toggle:text-black">Mostrar en Landing Page</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Marketing Strategy (Black Card) -->
        <div class="bg-zinc-800 rounded-2xl shadow-2xl p-10 md:p-12 relative overflow-hidden group">
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,rgba(255,255,255,0.05)_0%,transparent_60%)]"></div>
            
            <div class="relative z-10">
                <div class="flex items-center gap-4 mb-10">
                    <span class="w-10 h-10 bg-white text-black rounded-lg flex items-center justify-center font-black text-xs shadow-xl">02</span>
                    <h3 class="text-xl font-black tracking-tighter uppercase text-white">Estrategia de Marketing & Drops</h3>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                    <!-- Column 1: Active Modes -->
                    <div class="space-y-6">
                        <!-- Visibilidad / Ocultar -->
                        <div class="bg-white/5 border border-white/10 rounded-xl p-6 transition-all hover:bg-white/10">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <h4 class="text-[10px] font-black text-white uppercase tracking-widest">Visibilidad</h4>
                                    <p class="text-[9px] text-zinc-500 font-medium mt-1">Ocultar producto de la tienda</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="is_hidden" class="sr-only peer" checked={product.is_hidden} />
                                    <div class="w-10 h-6 bg-zinc-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-zinc-500"></div>
                                </label>
                            </div>
                        </div>

                        <!-- Limited Drop Module -->
                        <div class="bg-white/5 border border-white/10 rounded-xl p-6 transition-all hover:bg-white/10">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <h4 class="text-[10px] font-black text-white uppercase tracking-widest">Drop Limitado</h4>
                                    <p class="text-[9px] text-zinc-500 font-medium mt-1">Activar cuenta atrás visible</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="is_limited_drop" id="toggle-drop" class="sr-only peer" checked={product.is_limited_drop} />
                                    <div class="w-10 h-6 bg-zinc-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-red"></div>
                                </label>
                            </div>
                            <!-- Conditional visibility handled by script, but we default show if checked for server render? No, script handles class toggling. -->
                            <!-- We add 'hidden' if not checked initially -->
                            <div id="drop-config" class={`mt-4 pt-4 border-t border-white/5 animate-fade-in ${!product.is_limited_drop ? 'hidden' : ''}`}>
                                <label class="block text-[9px] font-black text-white/40 uppercase tracking-widest mb-2">Finalización del Drop</label>
                                <input type="datetime-local" name="drop_end_date" value={formatDateTime(product.drop_end_date)}
                                    class="w-full bg-zinc-700/50 border border-white/10 rounded-xl px-4 py-3 text-[10px] font-black text-white uppercase tracking-widest focus:outline-none focus:border-white/30 transition-all cursor-pointer invert opacity-80" />
                            </div>
                        </div>

                        <!-- Discount Module -->
                        <div class="bg-white/5 border border-white/10 rounded-xl p-6 transition-all hover:bg-white/10">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <h4 class="text-[10px] font-black text-white uppercase tracking-widest">Descuento Activo</h4>
                                    <p class="text-[9px] text-zinc-500 font-medium mt-1">Aplicar % reducción</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="discount_active" id="toggle-discount" class="sr-only peer" checked={product.discount_active} />
                                    <div class="w-10 h-6 bg-zinc-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                            <div id="discount-config" class={`mt-4 pt-4 border-t border-white/5 animate-fade-in space-y-4 ${!product.discount_active ? 'hidden' : ''}`}>
                                <div>
                                    <label class="block text-[9px] font-black text-white/40 uppercase tracking-widest mb-2">Porcentaje (%)</label>
                                    <input type="number" name="discount_percent" min="0" max="100" placeholder="20" value={product.discount_percent}
                                        class="w-full bg-zinc-700/50 border border-white/10 rounded-xl px-4 py-3 text-sm font-black text-white focus:outline-none focus:border-white/30" />
                                </div>
                                <div>
                                    <label class="block text-[9px] font-black text-white/40 uppercase tracking-widest mb-2">Válido Hasta (Opcional)</label>
                                    <input type="datetime-local" name="discount_end_date" value={formatDateTime(product.discount_end_date)}
                                        class="w-full bg-zinc-700/50 border border-white/10 rounded-xl px-4 py-3 text-[10px] font-black text-white uppercase tracking-widest focus:outline-none focus:border-white/30 transition-all cursor-pointer invert opacity-80" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2: Status & Tags -->
                    <div class="space-y-6">
                        <!-- Launch Protocol -->
                        <div class="bg-white/5 border border-white/10 rounded-xl p-6">
                            <h4 class="text-[10px] font-black text-white uppercase tracking-widest mb-4 flex items-center gap-2">
                                <svg class="w-4 h-4 text-brand-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Protocolo de Lanzamiento
                            </h4>
                            <div class="space-y-3">
                                <label class="text-[9px] font-black text-white/40 uppercase tracking-widest">Disponible desde</label>
                                <input type="datetime-local" name="launch_date" value={formatDateTime(product.launch_date)}
                                    class="w-full bg-zinc-700/50 border border-white/10 rounded-xl px-4 py-3 text-[10px] font-black text-white uppercase tracking-widest focus:outline-none focus:border-white/30 transition-all cursor-pointer invert opacity-80" />
                                <p class="text-[8px] text-zinc-500 mt-1 italic">*Si se define futuro, el producto aparecerá como "PRÓXIMAMENTE"</p>
                            </div>
                        </div>

                        <!-- Manual Tags -->
                        <div class="grid grid-cols-2 gap-4">
                            <label class="group flex items-center justify-between p-4 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 cursor-pointer transition-all">
                                <span class="text-[9px] font-black text-zinc-400 group-hover:text-white uppercase tracking-widest transition-colors">Viral Trend</span>
                                <div class="relative flex items-center">
                                    <input type="checkbox" name="is_viral_trend" class="peer sr-only" checked={product.is_viral_trend} />
                                    <div class="w-5 h-5 border-2 border-zinc-600 rounded bg-transparent peer-checked:bg-brand-red peer-checked:border-brand-red transition-all flex items-center justify-center">
                                        <svg class="w-3 h-3 text-black opacity-0 peer-checked:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                    <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 h-1 w-8 bg-purple-500 rounded-full opacity-50 group-hover:opacity-100 transition-opacity"></div>
                                </div>
                            </label>
                            
                            <label class="group flex items-center justify-between p-4 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 cursor-pointer transition-all">
                                <span class="text-[9px] font-black text-zinc-400 group-hover:text-white uppercase tracking-widest transition-colors">Bestseller</span>
                                <div class="relative flex items-center">
                                    <input type="checkbox" name="is_bestseller" class="peer sr-only" checked={product.is_bestseller} />
                                    <div class="w-5 h-5 border-2 border-zinc-600 rounded bg-transparent peer-checked:bg-white peer-checked:border-white transition-all flex items-center justify-center">
                                        <svg class="w-3 h-3 text-black opacity-0 peer-checked:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                    <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 h-1 w-8 bg-amber-400 rounded-full opacity-50 group-hover:opacity-100 transition-opacity"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Detailed Configuration -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-10">
            <div class="space-y-10">
                <!-- Colors Card -->
                <div class="bg-white rounded-2xl border border-black/5 p-10 md:p-12 shadow-sm">
                    <div class="flex items-center gap-4 mb-10">
                        <span class="w-10 h-10 bg-zinc-100 text-black rounded-lg flex items-center justify-center font-black text-xs border border-black/5">03</span>
                        <h3 class="text-lg font-black tracking-tighter uppercase text-black">Cromatografía</h3>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4" id="colors-selection">
                        {colorsMasterList.map(color => (
                            <label class="group relative flex items-center gap-3 p-4 rounded-xl bg-zinc-50 border-2 border-transparent hover:bg-white hover:border-black/10 cursor-pointer transition-all">
                                <input type="checkbox" name="product_colors" value={color.name} class="peer sr-only" checked={product.colors?.includes(color.name)} />
                                <div class="w-2 h-2 rounded-full border border-black/10 shadow-inner peer-checked:scale-150 transition-transform" style={`background-color: ${color.hex_code || '#f3f4f6'};`}></div>
                                <span class="text-[9px] font-black text-zinc-400 uppercase tracking-widest peer-checked:text-black transition-colors">{color.name}</span>
                                <div class="absolute inset-0 border-2 border-black rounded-xl opacity-0 peer-checked:opacity-10 scale-95 peer-checked:scale-100 transition-all"></div>
                            </label>
                        ))}
                    </div>
                </div>

                <!-- Stock Matrix -->
                <div class="bg-white rounded-2xl border border-black/5 p-10 md:p-12 shadow-sm">
                    <div class="flex items-center gap-4 mb-10">
                        <span class="w-10 h-10 bg-zinc-100 text-black rounded-lg flex items-center justify-center font-black text-xs border border-black/5">04</span>
                        <h3 class="text-lg font-black tracking-tighter uppercase text-black">Matriz de Stock</h3>
                    </div>

                    <div class="grid grid-cols-3 gap-6">
                        {['XS', 'S', 'M', 'L', 'XL', 'XXL'].map(size => (
                            <div class="group/size">
                                <label class="block text-[10px] font-black text-zinc-400 uppercase mb-2 text-center">{size}</label>
                                <input type="number" name={`stock_${size}`} min="0" value={product.stock_by_sizes?.[size] || 0}
                                    class="w-full bg-zinc-50 border-2 border-black/[0.02] rounded-2xl px-4 py-5 text-sm font-black text-center focus:outline-none focus:border-black focus:bg-white transition-all shadow-inner" />
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            <!-- Media Section -->
            <div class="bg-white rounded-2xl border border-black/5 p-10 md:p-12 shadow-sm flex flex-col">
                <div class="flex items-center gap-4 mb-10">
                    <span class="w-10 h-10 bg-zinc-100 text-black rounded-lg flex items-center justify-center font-black text-xs border border-black/5">05</span>
                    <h3 class="text-lg font-black tracking-tighter uppercase text-black">Activos Visuales</h3>
                </div>

                <div class="flex-1 flex flex-col">
                    <div class="border-2 border-dashed border-zinc-200 rounded-2xl p-10 text-center group hover:border-black transition-all relative cursor-pointer flex flex-col items-center justify-center gap-4 mb-10">
                        <input type="file" id="images" name="images" accept="image/*" multiple class="absolute inset-0 opacity-0 cursor-pointer" />
                        <div class="w-16 h-16 bg-zinc-50 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                             <svg class="w-8 h-8 text-zinc-300 group-hover:text-black transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        </div>
                        <p class="text-[10px] font-black uppercase tracking-widest text-black mb-1">Inyectar Nuevos Medios</p>
                    </div>

                    <div id="image-preview" class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                         {(product.images || []).map((img: string) => (
                             <div class="relative group aspect-[3/4] rounded-2xl overflow-hidden border border-black/[0.03] shadow-sm">
                                 <img src={img} class="w-full h-full object-cover grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-500" />
                                 <div class="absolute inset-0 bg-zinc-800/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                    <button type="button" class="remove-existing-image p-3 bg-red-600 text-white rounded-full hover:scale-110 transition-all shadow-xl" data-url={img}>
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    </button>
                                 </div>
                             </div>
                         ))}
                    </div>
                    
                    <div id="upload-progress" class="mt-10 hidden">
                        <div class="h-1.5 w-full bg-zinc-100 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-zinc-800 transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progress-text" class="text-[9px] font-black text-zinc-400 uppercase tracking-widest mt-3 text-center italic">Sincronizando con satélite...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Actions -->
        <div class="flex flex-col sm:flex-row items-center justify-end gap-6 pt-10 border-t border-black/[0.05]">
            <a href="/admin/products" class="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-400 hover:text-black transition-colors px-10 py-5">Abortar Misión</a>
            <button type="button" id="submit-btn" 
                class="w-full sm:w-auto bg-zinc-800 text-white px-16 py-6 rounded-xl text-[11px] font-black uppercase tracking-[0.5em] hover:scale-105 transition-all shadow-[0_20px_50px_rgba(0,0,0,0.2)] active:scale-95 group">
                <span class="group-hover:tracking-[0.6em] transition-all">Consolidar Cambios</span>
            </button>
        </div>
    </form>
  </div>
</AdminLayout>

  <script>
    import { supabase } from '../../../../lib/supabase';
    import { navigate } from 'astro:transitions/client';

    function initPage() {
        console.log('Edit Product Protocol Initialized');
        const form = document.getElementById('edit-product-form') as HTMLFormElement;
        if (!form) return;

        const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
        const imagesInput = document.getElementById('images') as HTMLInputElement;
        const imagePreview = document.getElementById('image-preview') as HTMLDivElement;
        const uploadProgress = document.getElementById('upload-progress') as HTMLDivElement;
        const progressBar = document.getElementById('progress-bar') as HTMLDivElement;
        
        // Initial state
        let isSubmitting = false;

        // Marketing Toggles
        const toggleDrop = document.getElementById('toggle-drop') as HTMLInputElement;
        const dropConfig = document.getElementById('drop-config');
        const toggleDiscount = document.getElementById('toggle-discount') as HTMLInputElement;
        const discountConfig = document.getElementById('discount-config');

        // Bind events if elements exist
        if (toggleDrop && dropConfig) {
            toggleDrop.addEventListener('change', () => {
                dropConfig.classList.toggle('hidden', !toggleDrop.checked);
            });
        }

        if (toggleDiscount && discountConfig) {
            toggleDiscount.addEventListener('change', () => {
                discountConfig.classList.toggle('hidden', !toggleDiscount.checked);
            });
        }

        // Manage existing images state
        const initialImagesInput = document.getElementById('initial-images') as HTMLInputElement;
        let currentImages = initialImagesInput ? JSON.parse(initialImagesInput.value || '[]') : [];
        let selectedFiles: File[] = [];
        
        // Remove existing image
        document.querySelectorAll('.remove-existing-image').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const button = e.currentTarget as HTMLButtonElement;
                const urlToRemove = button.dataset.url;
                currentImages = currentImages.filter((url: string) => url !== urlToRemove);
                button.closest('.relative')?.remove();
            });
        });
        
        // Image preview for NEW files
        if (imagesInput) {
            imagesInput.addEventListener('change', (e) => {
                const files = Array.from(imagesInput.files || []);
                if (!imagePreview) return;
                
                files.forEach((file) => {
                    // Prevent duplicates
                    if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) return;
                    
                    selectedFiles.push(file);

                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const div = document.createElement('div');
                        div.className = 'relative group rounded-2xl overflow-hidden border border-black/5 aspect-square bg-zinc-50';
                        div.innerHTML = `
                            <img src="${evt.target?.result}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" />
                            <div class="absolute top-2 left-2 bg-blue-500 text-white text-[9px] font-black uppercase tracking-wider px-2 py-1 rounded-lg shadow-lg z-10">Nuevo</div>
                            <div class="absolute inset-0 bg-zinc-800/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center z-20">
                                <button type="button" class="remove-new-image p-3 bg-red-600 text-white rounded-full hover:scale-110 transition-all shadow-xl">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                        `;
                        
                        div.querySelector('.remove-new-image')?.addEventListener('click', () => {
                            selectedFiles = selectedFiles.filter(f => f !== file);
                            div.remove();
                        });

                        imagePreview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
                
                imagesInput.value = '';
            });
        }

        // Upload function
        async function uploadImagesToCloudinary(files: File[]): Promise<string[]> {
            const cloudName = import.meta.env.PUBLIC_CLOUDINARY_CLOUD_NAME;
            const uploadPreset = import.meta.env.PUBLIC_CLOUDINARY_PRESET || 'croma_uploads';
            const urls: string[] = [];

            if (uploadProgress) uploadProgress.classList.remove('hidden');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', uploadPreset);
                formData.append('folder', 'croma/products');

                try {
                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,
                    { method: 'POST', body: formData }
                );

                if (!response.ok) throw new Error('Upload failed');
                const data = await response.json();
                urls.push(data.secure_url);
                
                if (progressBar) progressBar.style.width = `${((i + 1) / files.length) * 100}%`;

                } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
                }
            }
            if (uploadProgress) uploadProgress.classList.add('hidden');
            return urls;
        }

        // Prevent native form submission (Critical for preventing AbortError)
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            return false;
        });

        if (submitBtn) {
            // Clone button to remove old listeners (safety measure)
            const newBtn = submitBtn.cloneNode(true) as HTMLButtonElement;
            submitBtn.parentNode?.replaceChild(newBtn, submitBtn);
            
            newBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();

                // Manual Validation
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                if (isSubmitting) return;
                isSubmitting = true;

                newBtn.disabled = true;
                newBtn.innerHTML = '<span class="animate-pulse">SINCRONIZANDO...</span>';

                try {
                    // Upload new images
                    let uploadedImageUrls: string[] = [];
                    if (selectedFiles.length > 0) {
                        uploadedImageUrls = await uploadImagesToCloudinary(selectedFiles);
                    }

                    // Combine old and new images
                    const finalImages = [...currentImages, ...uploadedImageUrls];

                    const formData = new FormData(form);
                    const name = formData.get('name') as string;
                    const description = formData.get('description') as string;
                    const price = parseFloat(formData.get('price') as string);
                    const category = formData.get('category') as string;
                    const brand = formData.get('brand') as string;
                    const featured = formData.get('featured') === 'on';
                    const productId = formData.get('id') as string;

                    // Marketing Fields Extraction
                    const islimitedDrop = formData.get('is_limited_drop') === 'on';
                    const dropEndDate = formData.get('drop_end_date') ? new Date(formData.get('drop_end_date') as string).toISOString() : null;
                    const discountActive = formData.get('discount_active') === 'on';
                    const discountPercent = parseInt(formData.get('discount_percent') as string) || 0;
                    const discountEndDate = formData.get('discount_end_date') ? new Date(formData.get('discount_end_date') as string).toISOString() : null;
                    const launchDate = formData.get('launch_date') ? new Date(formData.get('launch_date') as string).toISOString() : null;
                    const isViralTrend = formData.get('is_viral_trend') === 'on';
                    const isBestseller = formData.get('is_bestseller') === 'on';
                    const isHidden = formData.get('is_hidden') === 'on';


                    const colors = Array.from(form.querySelectorAll('input[name="product_colors"]:checked'))
                        .map(i => (i as HTMLInputElement).value);

                    const stockBySizes: Record<string, number> = {};
                    form.querySelectorAll('input[name^="stock_"]').forEach(input => {
                        const size = (input as HTMLInputElement).name.replace('stock_', '');
                        const quantity = parseInt((input as HTMLInputElement).value) || 0;
                        if (quantity > 0) stockBySizes[size] = quantity;
                    });

                    // Update product using RPC
                    const slug = name.toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-+|-+$/g, '');

                    console.log('Dispatching admin_update_product...');
                    
                    // Simulate a small delay to ensure UI updates before potential heavy work
                    await new Promise(resolve => setTimeout(resolve, 100));

                    const { data, error: updateError } = await supabase.rpc('admin_update_product', {
                        p_product_id: productId,
                        p_updates: {
                            name, slug, description, price, category, brand, images: finalImages, 
                            stock_by_sizes: stockBySizes, featured, colors,
                            // New Fields
                            is_limited_drop: islimitedDrop,
                            drop_end_date: dropEndDate,
                            discount_active: discountActive,
                            discount_percent: discountPercent,
                            discount_end_date: discountEndDate,
                            launch_date: launchDate,
                            is_viral_trend: isViralTrend,
                            is_bestseller: isBestseller,
                            is_hidden: isHidden
                        }
                    });
                    
                    if (updateError) throw updateError;

                    (window as any).showIndustrialAlert('ARTÍCULO ACTUALIZADO CORRECTAMENTE', 'success');
                    
                    // Delay navigation slightly to allow user to see success message
                    setTimeout(() => {
                        // Use window.location as fallback if navigate fails or for full consistency
                        window.location.href = '/admin/products';
                    }, 500);


                } catch (error) {
                    console.error('Error updating:', error);
                    let msg = 'Error desconocido';
                    if (error instanceof Error) msg = error.message;
                    if ((error as any)?.name === 'AbortError') msg = 'Conexión interrumpida. Por favor, reintente.';
                    
                    (window as any).showIndustrialAlert('ERROR EN ACTUALIZACIÓN: ' + msg, 'error');
                    
                    if (newBtn) {
                        newBtn.disabled = false;
                        newBtn.textContent = 'Reintentar Guardado';
                    }
                    isSubmitting = false;
                }
            });
        }
    }

    // Attach to page load for Astro View Transitions compatibility
    document.addEventListener('astro:page-load', initPage);
  </script>

