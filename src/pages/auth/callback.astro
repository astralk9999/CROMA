---
import { supabase } from '@lib/supabase';

const code = Astro.url.searchParams.get('code');

if (code) {
  // Exchange code for session
  const { data, error } = await supabase.auth.exchangeCodeForSession(code);

  if (error) {
    return Astro.redirect('/auth/login?error=' + encodeURIComponent(error.message));
  }

  if (data.session) {
    // Set cookies
    Astro.cookies.set('sb-access-token', data.session.access_token, {
      path: '/',
      maxAge: 3600,
    });
    Astro.cookies.set('sb-refresh-token', data.session.refresh_token, {
      path: '/',
      maxAge: 604800,
    });

    // Get user profile to check role
    const { data: profile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', data.user.id)
      .single();

    // Redirect based on role
    if (profile?.role === 'admin') {
      return Astro.redirect('/admin/dashboard');
    } else {
      return Astro.redirect('/');
    }
  }
}

return Astro.redirect('/auth/login');
---
