---
import PublicLayout from '@layouts/PublicLayout.astro';
import ProductGallery from '@components/product/ProductGallery.astro';
import AddToCartButton from '@components/islands/AddToCartButton';
import Countdown from '@components/islands/Countdown';
import StockStatus from '@components/islands/StockStatus';
import { supabase } from '@lib/supabase';
import { formatPrice } from '@lib/utils';

const { slug } = Astro.params;

let product;

// Fetch from DB
const { data: dbProduct } = await supabase
  .from('products')
  .select('*')
  .eq('slug', slug)
  .single();

product = dbProduct;

// Add generic category object for breadcrumbs if missing relation but text exists
if (product && product.category && !product.categories) {
    product.categories = {
        name: product.category.toUpperCase().replace(/-/g, ' '),
        slug: product.category
    };
}

if (!product) {
  return Astro.redirect('/404');
}

const mainImage = product.images?.[0] || '/placeholder.jpg';

// Check if product is not yet available (Drop)
const availableFrom = product.available_from ? new Date(product.available_from) : null;
const isNotYetAvailable = availableFrom ? availableFrom > new Date() : false;

// STRICT STOCK LOGIC:
// We only count stock that is explicitly assigned to a size in stock_by_sizes.
// Legacy 'stock' column is ignored to prevent phantom inventory.
const effectiveStock = (product.stock_by_sizes && Object.keys(product.stock_by_sizes).length > 0)
  ? Object.values(product.stock_by_sizes).reduce((sum: number, quantity: unknown) => sum + (quantity as number), 0)
  : 0;
---

<PublicLayout title={product.name} description={product.description}>
  <section class="container-custom py-12">
    {/* Industrial Breadcrumbs */}
    <nav class="mb-10">
      <div class="flex items-center gap-4 mb-3">
        <span class="px-2 py-0.5 bg-black text-white text-[7px] font-mono font-black uppercase tracking-widest">PRODUCT_LINK_V5</span>
        <div class="h-[1px] flex-1 bg-black/10"></div>
      </div>
      <ol class="flex flex-wrap items-center gap-x-2 gap-y-1 text-[9px] font-black uppercase tracking-[0.2em] text-zinc-400">
        <li><a href="/" class="hover:text-black transition-colors">ROOT</a></li>
        <li class="text-zinc-200">/</li>
        <li><a href="/productos" class="hover:text-black transition-colors">COLLECTION</a></li>
        {product.categories && (
          <>
            <li class="text-zinc-200">/</li>
            <li>
                <a href={`/category/${product.category}`} class="hover:text-black transition-colors">
                    {product.categories.name}
                </a>
            </li>
          </>
        )}
        <li class="text-zinc-200">/</li>
        <li class="text-black italic">{product.name}</li>
      </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-16">
      {/* Product Gallery (Left) */}
      <div class="lg:col-span-7">
        <ProductGallery images={product.images || [mainImage]} productName={product.name} />
      </div>

      {/* Product Info (Right) */}
      <div class="lg:col-span-5 lg:sticky lg:top-24 self-start">
        {/* Release Status */}
        {isNotYetAvailable && (
          <div class="mb-6 flex items-center gap-2">
            <span class="flex h-1.5 w-1.5 rounded-full bg-brand-red animate-pulse"></span>
            <span class="text-[9px] font-mono font-black uppercase tracking-[0.3em] text-brand-red">DROP_SCHEDULED</span>
          </div>
        )}

        <div class="mb-8">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-[9px] font-mono font-black text-zinc-300">REF_{product.id.toString().slice(0,8).toUpperCase()}</span>
                <div class="h-[1px] w-6 bg-zinc-200"></div>
            </div>
            <h1 class="text-4xl md:text-5xl font-urban font-black uppercase tracking-tighter text-black leading-[0.85] mb-4 italic">
                {product.name}
            </h1>
            
            <div class="flex items-baseline gap-3 mt-6 pt-6 border-t-2 border-black/5">
                {(product.discount_active && product.discount_percent) || (product.sale_price && product.sale_price < product.price) ? (
                    <>
                        <span class="text-3xl md:text-4xl font-urban font-black tracking-tighter text-brand-red">
                            {formatPrice(
                                product.discount_active 
                                ? product.price * (1 - (product.discount_percent || 0)/100) 
                                : (product.sale_price || product.price)
                            )}
                        </span>
                        <span class="text-xl font-urban font-bold text-zinc-300 line-through tracking-tighter decoration-zinc-300">
                            {formatPrice(product.price)}
                        </span>
                        <div class="ml-auto bg-black text-white text-[9px] font-black px-3 py-0.5 uppercase tracking-widest transform -skew-x-12">
                            {(product.discount_active && product.discount_percent) 
                                ? `${product.discount_percent}%_OFF` 
                                : `${Math.round((1 - (product.sale_price || 0) / product.price) * 100)}%_OFF`
                            }
                        </div>
                    </>
                ) : (
                    <span class="text-3xl md:text-4xl font-urban font-black tracking-tighter text-black">
                        {formatPrice(product.price)}
                    </span>
                )}
            </div>
        </div>

        {product.description && (
          <div class="mb-10">
            <h3 class="text-[9px] font-mono font-black uppercase tracking-[0.3em] text-zinc-300 mb-3 italic underline decoration-zinc-100 underline-offset-4">MANIFESTO_DESCRIPTION</h3>
            <p class="text-xs font-bold uppercase tracking-wider leading-relaxed text-zinc-500 italic max-w-lg">
              {product.description}
            </p>
          </div>
        )}

        {/* Countdown for Drops */}
        {isNotYetAvailable && availableFrom && (
          <div class="mb-10 p-8 bg-zinc-50 translate-y-1 hover:translate-y-0 transition-transform">
            <Countdown 
              client:load
              targetDate={availableFrom.toISOString()} 
              title="DROP_COMMENCING_IN"
            />
          </div>
        )}

        {/* Stock Status */}
        <div class="mb-10">
            <h3 class="text-[9px] font-mono font-black uppercase tracking-[0.3em] text-zinc-300 mb-4 italic underline decoration-zinc-100 underline-offset-4">INVENTORY_PROTOCOL</h3>
            <StockStatus 
                client:load 
                stock={effectiveStock} 
                isNotYetAvailable={isNotYetAvailable} 
            />
        </div>

        {/* Add to Cart Section */}
        <div class="space-y-8 p-8 bg-zinc-50">
            <AddToCartButton 
                client:load
                product={{
                    id: product.id,
                    name: product.name,
                    slug: product.slug,
                    price: product.price,
                    image: mainImage,
                    sizes: product.sizes || [],
                    stock: effectiveStock,
                    stockBySizes: product.stock_by_sizes || undefined,
                    discount_active: product.discount_active,
                    discount_percent: product.discount_percent,
                    sale_price: product.sale_price
                }}
                isNotYetAvailable={isNotYetAvailable}
            />
        </div>

        {/* System Perks */}
        <div class="mt-12 pt-8 border-t-2 border-black grid grid-cols-2 gap-6">
            <div class="space-y-1">
                <span class="text-[7px] font-mono font-black text-zinc-300 block mb-1 uppercase">LOGISTICS_01</span>
                <p class="text-[9px] font-black uppercase tracking-widest text-black italic">ENVÍO_EXPRESS_GRATIS</p>
                <p class="text-[8px] font-bold text-zinc-400 uppercase tracking-wider">ORDERS > 50€ // 24H_ETA</p>
            </div>
            <div class="space-y-1">
                <span class="text-[7px] font-mono font-black text-zinc-300 block mb-1 uppercase">REVERSE_02</span>
                <p class="text-[9px] font-black uppercase tracking-widest text-black italic">RETURN_PROTOCOL_ACTIVE</p>
                <p class="text-[8px] font-bold text-zinc-400 uppercase tracking-wider">30_DÍAS // RISK_FREE</p>
            </div>
        </div>
      </div>
    </div>
  </section>
</PublicLayout>

<script define:vars={{ productId: product.id }}>
  // Track product view for recently viewed reminders
  if (productId) {
    fetch('/api/track-view', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId }),
      credentials: 'include'
    }).catch(() => {}); // Silent fail for guests
  }
</script>
