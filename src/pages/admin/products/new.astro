---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';
import { supabaseAdmin } from '@lib/supabase-admin';

const user = Astro.locals.user;
const profile = Astro.locals.profile;

if (!user || profile?.role !== 'admin') {
  return Astro.redirect('/auth/login');
}

// Fetch categories and brands for dropdowns
const { data: categories } = await supabaseAdmin
  .from('categories')
  .select('*')
  .order('name');

const { data: brands } = await supabaseAdmin
  .from('brands')
  .select('*')
  .order('name');

const { data: allColors } = await supabaseAdmin
  .from('colors')
  .select('*')
  .order('name');

const existingCategories = categories?.map(c => c.name) || [];
const existingBrands = brands?.map(b => b.name) || [];
const colorsMasterList = allColors || [];

// Fallback defaults if empty
if (existingCategories.length === 0) {
    existingCategories.push('jackets', 't-shirts', 'trousers', 'shoes');
}
if (existingBrands.length === 0) {
    existingBrands.push('croma', 'urban-essentials');
}
---

<AdminLayout title="Ingreso de Registro" activeSection="products">
  <div class="max-w-5xl mx-auto">
    <!-- Header Section -->
    <div class="mb-12 flex flex-col md:flex-row md:items-end justify-between gap-6 px-4">
        <div>
            <h2 class="text-3xl font-black tracking-tighter text-black uppercase">Nuevo Artículo</h2>
            <p class="text-[10px] font-bold text-zinc-400 uppercase tracking-[0.3em] mt-2 italic">Definición de propiedades y despliegue logístico</p>
        </div>
        <a href="/admin/products" class="group flex items-center gap-3 text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-black transition-colors">
            <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
            Volver al Depósito
        </a>
    </div>

    <form id="product-form" class="space-y-10 mb-20">
        <!-- Section 1: Identity -->
        <div class="bg-white rounded-2xl border border-black/5 shadow-sm p-10 md:p-12 relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-64 h-64 bg-zinc-50 rounded-full translate-x-1/2 -translate-y-1/2 -z-0"></div>
            
            <div class="relative z-10">
                <div class="flex items-center gap-4 mb-10">
                    <span class="w-10 h-10 bg-zinc-700 text-white rounded-xl flex items-center justify-center font-black text-xs">01</span>
                    <h3 class="text-xl font-black tracking-tighter uppercase text-black">Identidad del Producto</h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="md:col-span-2 space-y-3">
                        <label for="name" class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4 flex items-center gap-2">
                             Denominación Comercial <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="name" name="name" required 
                            class="w-full bg-zinc-50 border-2 border-black/[0.03] rounded-2xl px-8 py-5 text-sm font-black uppercase tracking-tight focus:outline-none focus:border-black focus:bg-white transition-all placeholder:text-zinc-200" 
                            placeholder="EJ: BOMBER INDUSTRIAL V1" />
                    </div>

                    <div class="md:col-span-2 space-y-3">
                        <label for="description" class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4">Especificaciones Técnicas</label>
                        <textarea id="description" name="description" rows="4" 
                            class="w-full bg-zinc-50 border-2 border-black/[0.03] rounded-xl px-8 py-6 text-sm font-medium focus:outline-none focus:border-black focus:bg-white transition-all placeholder:text-zinc-200" 
                            placeholder="DETALLE COMPLETO DEL ARTÍCULO..."></textarea>
                    </div>

                    <div class="space-y-3">
                        <label for="price" class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4">Valoración Base (€) <span class="text-red-500">*</span></label>
                        <input type="number" id="price" name="price" required step="0.01" min="0" 
                            class="w-full bg-zinc-50 border-2 border-black/[0.03] rounded-2xl px-8 py-5 text-sm font-black tracking-tight focus:outline-none focus:border-black focus:bg-white transition-all placeholder:text-zinc-200" 
                            placeholder="00.00" />
                    </div>

                    <div class="space-y-3">
                       <label class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4">Sector / Categoría <span class="text-red-500">*</span></label>
                       <div class="relative">
                            <select name="category" required 
                                class="w-full bg-zinc-50 border-2 border-black/[0.03] rounded-2xl px-8 py-5 text-[10px] font-black uppercase tracking-widest focus:outline-none focus:border-black focus:bg-white transition-all appearance-none cursor-pointer">
                                <option value="">NO ASIGNADO</option>
                                {categories?.map(cat => (
                                    <option value={cat.name}>{cat.name?.toUpperCase()}</option>
                                ))}
                            </select>
                            <svg class="absolute right-6 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"/></svg>
                       </div>
                    </div>

                    <div class="space-y-3">
                       <label class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4">Corporación / Marca <span class="text-red-500">*</span></label>
                       <div class="relative">
                            <select name="brand" required 
                                class="w-full bg-zinc-50 border-2 border-black/[0.03] rounded-2xl px-8 py-5 text-[10px] font-black uppercase tracking-widest focus:outline-none focus:border-black focus:bg-white transition-all appearance-none cursor-pointer">
                                <option value="">NO ASIGNADO</option>
                                {brands?.map(brand => (
                                    <option value={brand.name}>{brand.name?.toUpperCase()}</option>
                                ))}
                            </select>
                            <svg class="absolute right-6 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"/></svg>
                       </div>
                    </div>

                    <div class="flex items-center gap-6 px-4">
                        <label class="relative inline-flex items-center cursor-pointer group/toggle">
                            <input type="checkbox" name="featured" class="sr-only peer" />
                            <div class="w-14 h-8 bg-zinc-100 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-zinc-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-zinc-800"></div>
                            <span class="ml-4 text-[10px] font-black text-zinc-400 uppercase tracking-widest group-checked/toggle:text-black">Mostrar en Landing Page</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Marketing Strategy (Black Card) -->
        <div class="bg-zinc-800 rounded-2xl shadow-2xl p-10 md:p-12 relative overflow-hidden group">
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,rgba(255,255,255,0.05)_0%,transparent_60%)]"></div>
            
            <div class="relative z-10">
                <div class="flex items-center gap-4 mb-10">
                    <span class="w-10 h-10 bg-white text-black rounded-xl flex items-center justify-center font-black text-xs shadow-xl">02</span>
                    <h3 class="text-xl font-black tracking-tighter uppercase text-white">Estrategia de Marketing & Drops</h3>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                    <!-- Column 1: Active Modes -->
                    <div class="space-y-6">
                        <!-- Visibilidad / Ocultar -->
                        <div class="bg-white/5 border border-white/10 rounded-2xl p-6 transition-all hover:bg-white/10">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <h4 class="text-[10px] font-black text-white uppercase tracking-widest">Visibilidad</h4>
                                    <p class="text-[9px] text-zinc-500 font-medium mt-1">Ocultar producto de la tienda</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="is_hidden" class="sr-only peer" />
                                    <div class="w-10 h-6 bg-zinc-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-zinc-500"></div>
                                </label>
                            </div>
                        </div>

                        <!-- Drop Limitado Module -->
                        <div class="bg-white/5 border border-white/10 rounded-2xl p-6 transition-all hover:bg-white/10">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <h4 class="text-[10px] font-black text-white uppercase tracking-widest">Drop Limitado</h4>
                                    <p class="text-[9px] text-zinc-500 font-medium mt-1">Activar cuenta atrás visible</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="is_limited_drop" id="toggle-drop" class="sr-only peer" />
                                    <div class="w-10 h-6 bg-zinc-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-red"></div>
                                </label>
                            </div>
                            <div id="drop-config" class="hidden mt-4 pt-4 border-t border-white/5 animate-fade-in">
                                <label class="block text-[9px] font-black text-white/40 uppercase tracking-widest mb-2">Finalización del Drop</label>
                                <input type="datetime-local" name="drop_end_date" 
                                    class="w-full bg-zinc-700/50 border border-white/10 rounded-xl px-4 py-3 text-[10px] font-black text-white uppercase tracking-widest focus:outline-none focus:border-white/30 transition-all cursor-pointer invert opacity-80" />
                            </div>
                        </div>

                        <!-- Discount Module -->
                        <div class="bg-white/5 border border-white/10 rounded-2xl p-6 transition-all hover:bg-white/10">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <h4 class="text-[10px] font-black text-white uppercase tracking-widest">Descuento Activo</h4>
                                    <p class="text-[9px] text-zinc-500 font-medium mt-1">Aplicar % reducción</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="discount_active" id="toggle-discount" class="sr-only peer" />
                                    <div class="w-10 h-6 bg-zinc-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                            <div id="discount-config" class="hidden mt-4 pt-4 border-t border-white/5 animate-fade-in space-y-4">
                                <div>
                                    <label class="block text-[9px] font-black text-white/40 uppercase tracking-widest mb-2">Porcentaje (%)</label>
                                    <input type="number" name="discount_percent" min="0" max="100" placeholder="20"
                                        class="w-full bg-zinc-700/50 border border-white/10 rounded-xl px-4 py-3 text-sm font-black text-white focus:outline-none focus:border-white/30" />
                                </div>
                                <div>
                                    <label class="block text-[9px] font-black text-white/40 uppercase tracking-widest mb-2">Válido Hasta (Opcional)</label>
                                    <input type="datetime-local" name="discount_end_date" 
                                        class="w-full bg-zinc-700/50 border border-white/10 rounded-xl px-4 py-3 text-[10px] font-black text-white uppercase tracking-widest focus:outline-none focus:border-white/30 transition-all cursor-pointer invert opacity-80" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2: Status & Tags -->
                    <div class="space-y-6">
                        <!-- Launch Protocol -->
                        <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
                            <h4 class="text-[10px] font-black text-white uppercase tracking-widest mb-4 flex items-center gap-2">
                                <svg class="w-4 h-4 text-brand-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Protocolo de Lanzamiento
                            </h4>
                            <div class="space-y-3">
                                <label class="text-[9px] font-black text-white/40 uppercase tracking-widest">Disponible desde</label>
                                <input type="datetime-local" name="launch_date" 
                                    class="w-full bg-zinc-700/50 border border-white/10 rounded-xl px-4 py-3 text-[10px] font-black text-white uppercase tracking-widest focus:outline-none focus:border-white/30 transition-all cursor-pointer invert opacity-80" />
                                <p class="text-[8px] text-zinc-500 mt-1 italic">*Si se define futuro, el producto aparecerá como "PRÓXIMAMENTE"</p>
                            </div>
                        </div>

                        <!-- Manual Tags -->
                        <div class="grid grid-cols-2 gap-4">
                            <label class="group flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 cursor-pointer transition-all">
                                <span class="text-[9px] font-black text-zinc-400 group-hover:text-white uppercase tracking-widest transition-colors">Viral Trend</span>
                                <div class="relative flex items-center">
                                    <input type="checkbox" name="is_viral_trend" class="peer sr-only" />
                                    <div class="w-5 h-5 border-2 border-zinc-600 rounded bg-transparent peer-checked:bg-brand-red peer-checked:border-brand-red transition-all flex items-center justify-center">
                                        <svg class="w-3 h-3 text-black opacity-0 peer-checked:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                    <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 h-1 w-8 bg-purple-500 rounded-full opacity-50 group-hover:opacity-100 transition-opacity"></div>
                                </div>
                            </label>
                            
                            <label class="group flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 cursor-pointer transition-all">
                                <span class="text-[9px] font-black text-zinc-400 group-hover:text-white uppercase tracking-widest transition-colors">Bestseller</span>
                                <div class="relative flex items-center">
                                    <input type="checkbox" name="is_bestseller" class="peer sr-only" />
                                    <div class="w-5 h-5 border-2 border-zinc-600 rounded bg-transparent peer-checked:bg-white peer-checked:border-white transition-all flex items-center justify-center">
                                        <svg class="w-3 h-3 text-black opacity-0 peer-checked:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                    <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 h-1 w-8 bg-amber-400 rounded-full opacity-50 group-hover:opacity-100 transition-opacity"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Configuration -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-10">
            <!-- Colors & Stock -->
            <div class="space-y-10">
                <!-- Colors Card -->
                <div class="bg-white rounded-2xl border border-black/5 p-10 md:p-12 shadow-sm">
                    <div class="flex items-center gap-4 mb-10">
                        <span class="w-10 h-10 bg-zinc-100 text-black rounded-xl flex items-center justify-center font-black text-xs border border-black/5">03</span>
                        <h3 class="text-lg font-black tracking-tighter uppercase text-black">Cromatografía</h3>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4" id="colors-selection">
                        {colorsMasterList.map(color => (
                            <label class="group relative flex items-center gap-3 p-4 rounded-xl bg-zinc-50 border-2 border-transparent hover:bg-white hover:border-black/10 cursor-pointer transition-all">
                                <input type="checkbox" name="product_colors" value={color.name} class="peer sr-only" />
                                <div class="w-2 h-2 rounded-full border border-black/10 shadow-inner peer-checked:scale-150 transition-transform" style={`background-color: ${color.hex_code || '#f3f4f6'};`}></div>
                                <span class="text-[9px] font-black text-zinc-400 uppercase tracking-widest peer-checked:text-black transition-colors">{color.name}</span>
                                <div class="absolute inset-0 border-2 border-black rounded-xl opacity-0 peer-checked:opacity-10 scale-95 peer-checked:scale-100 transition-all"></div>
                            </label>
                        ))}
                    </div>
                </div>

                <!-- Stock Card -->
                <div class="bg-white rounded-2xl border border-black/5 p-10 md:p-12 shadow-sm">
                    <div class="flex items-center gap-4 mb-10">
                        <span class="w-10 h-10 bg-zinc-100 text-black rounded-lg flex items-center justify-center font-black text-xs border border-black/5">04</span>
                        <h3 class="text-lg font-black tracking-tighter uppercase text-black">Matriz de Stock</h3>
                    </div>

                    <div class="mb-10 space-y-3">
                        <label class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4 italic">Definir Protocolo de Tallas</label>
                        <div class="relative">
                            <select id="size-type-selector" class="w-full bg-zinc-700 text-white rounded-2xl px-8 py-5 text-[10px] font-black uppercase tracking-widest appearance-none cursor-pointer">
                                <option value="clothing">TEXTIL (XS - XXL)</option>
                                <option value="footwear">CALZADO (36 - 46)</option>
                                <option value="onesize">MAGNITUD ÚNICA / ACCESORIOS</option>
                            </select>
                             <svg class="absolute right-6 top-1/2 -translate-y-1/2 w-4 h-4 text-white/40 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"/></svg>
                        </div>
                    </div>

                    <!-- Clothing Matrix -->
                    <div id="stock-clothing" class="size-group grid grid-cols-3 gap-4">
                        {['XS', 'S', 'M', 'L', 'XL', 'XXL'].map(size => (
                            <div class="group/size">
                                <label class="block text-[10px] font-black text-zinc-400 uppercase mb-2 text-center">{size}</label>
                                <input type="number" name={`stock_${size}`} min="0" placeholder="0" 
                                    class="stock-input w-full bg-zinc-50 border-2 border-black/[0.02] rounded-xl px-4 py-4 text-sm font-black text-center focus:outline-none focus:border-black focus:bg-white transition-all" />
                            </div>
                        ))}
                    </div>

                    <!-- Footwear Matrix -->
                    <div id="stock-footwear" class="size-group hidden grid grid-cols-4 gap-4">
                        {Array.from({length: 11}, (_, i) => i + 36).map(size => (
                             <div class="group/size">
                                <label class="block text-[10px] font-black text-zinc-400 uppercase mb-2 text-center">{size}</label>
                                <input type="number" name={`stock_${size}`} min="0" placeholder="0" 
                                    class="stock-input w-full bg-zinc-50 border-2 border-black/[0.02] rounded-xl px-2 py-4 text-xs font-black text-center focus:outline-none focus:border-black focus:bg-white transition-all" />
                            </div>
                        ))}
                    </div>

                    <!-- One Size Matrix -->
                    <div id="stock-onesize" class="size-group hidden">
                         <div class="space-y-3">
                            <label class="text-[10px] font-black text-zinc-400 uppercase tracking-widest px-4">Unidades Totales</label>
                            <input type="number" name="stock_TU" min="0" placeholder="0" 
                                class="stock-input w-full bg-zinc-50 border-2 border-black/[0.03] rounded-2xl px-8 py-5 text-sm font-black focus:outline-none focus:border-black focus:bg-white transition-all" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Media Section -->
            <div class="bg-white rounded-2xl border border-black/5 p-10 md:p-12 shadow-sm flex flex-col">
                <div class="flex items-center gap-4 mb-10">
                    <span class="w-10 h-10 bg-zinc-100 text-black rounded-xl flex items-center justify-center font-black text-xs border border-black/5">05</span>
                    <h3 class="text-lg font-black tracking-tighter uppercase text-black">Activos Visuales</h3>
                </div>

                <div class="flex-1 flex flex-col">
                    <div class="border-2 border-dashed border-zinc-200 rounded-2xl p-12 text-center group hover:border-black transition-all relative cursor-pointer flex flex-col items-center justify-center gap-6">
                        <input type="file" id="images" name="images" accept="image/*" multiple class="absolute inset-0 opacity-0 cursor-pointer" />
                        <div class="w-20 h-20 bg-zinc-50 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                             <svg class="w-10 h-10 text-zinc-300 group-hover:text-black transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        </div>
                        <div>
                            <p class="text-xs font-black uppercase tracking-widest text-black mb-1">Cargar Manifiesto Visual</p>
                            <p class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest mt-1">Soporta múltiples archivos de alta resolución</p>
                        </div>
                    </div>

                    <div id="image-preview" class="mt-10 grid grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    
                    <div id="upload-progress" class="mt-10 hidden">
                        <div class="h-1.5 w-full bg-zinc-100 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-zinc-800 transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progress-text" class="text-[9px] font-black text-zinc-400 uppercase tracking-widest mt-3 text-center italic">Sincronizando con satélite...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terminal Actions -->
        <div class="flex flex-col sm:flex-row items-center justify-end gap-6 pt-10 border-t border-black/[0.05]">
            <a href="/admin/products" class="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-400 hover:text-black transition-colors px-8 py-5">Abortar Misión</a>
            <button type="button" id="submit-btn" 
                class="w-full sm:w-auto bg-zinc-800 text-white px-12 py-5 rounded-xl text-[10px] font-black uppercase tracking-[0.4em] hover:scale-105 transition-all shadow-2xl active:scale-95 group">
                <span class="group-hover:tracking-[0.5em] transition-all">Desplegar Artículo</span>
            </button>
        </div>
    </form>
  </div>
  <script>
    import { supabase } from '@lib/supabase';
    import { navigate } from 'astro:transitions/client';

    function initPage() {
        console.log('Product Deployment Protocol Initialized');
        const form = document.getElementById('product-form') as HTMLFormElement;
        if (!form) return;

        const addColorBtn = document.getElementById('add-color-btn');
        const colorsContainer = document.getElementById('colors-container');
        const sizeTypeSelector = document.getElementById('size-type-selector') as HTMLSelectElement;
        const imagesInput = document.getElementById('images') as HTMLInputElement;
        const imagePreview = document.getElementById('image-preview');
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        const submitBtn = document.getElementById('submit-btn');

        // Marketing Toggles
        const toggleDrop = document.getElementById('toggle-drop') as HTMLInputElement;
        const dropConfig = document.getElementById('drop-config');
        const toggleDiscount = document.getElementById('toggle-discount') as HTMLInputElement;
        const discountConfig = document.getElementById('discount-config');

        toggleDrop?.addEventListener('change', () => {
            dropConfig?.classList.toggle('hidden', !toggleDrop.checked);
        });

        toggleDiscount?.addEventListener('change', () => {
            discountConfig?.classList.toggle('hidden', !toggleDiscount.checked);
        });

        let selectedFiles: File[] = [];
        let isSubmitting = false;

        // Matrix Logic
                sizeTypeSelector?.addEventListener('change', () => {
                    const type = sizeTypeSelector.value;
                    document.querySelectorAll('.size-group').forEach(g => g.classList.add('hidden'));
                    document.getElementById(`stock-${type}`)?.classList.remove('hidden');
                });

        // Visual Asset Preview
        imagesInput?.addEventListener('change', () => {
            if (!imagePreview) return;
            const newFiles = Array.from(imagesInput.files || []);
            
            newFiles.forEach(file => {
                // Prevent duplicates based on name and size (simple check)
                if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) return;
                
                selectedFiles.push(file);

                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'relative group rounded-2xl overflow-hidden border border-black/5 aspect-square bg-zinc-50';
                    div.innerHTML = `
                        <img src="${e.target?.result}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" />
                        <div class="absolute inset-0 bg-zinc-800/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <button type="button" class="remove-new-image p-3 bg-red-600 text-white rounded-full hover:scale-110 transition-all shadow-xl">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    `;
                    
                    // Add remove functionality
                    div.querySelector('.remove-new-image')?.addEventListener('click', () => {
                        selectedFiles = selectedFiles.filter(f => f !== file);
                        div.remove();
                    });

                    imagePreview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
            
            // Reset input to allow selecting the same file again if needed
            imagesInput.value = '';
        });

        // Cloudinary Pipeline
        async function uploadToCloud(files: File[]) {
            const cloudName = import.meta.env.PUBLIC_CLOUDINARY_CLOUD_NAME;
            const preset = import.meta.env.PUBLIC_CLOUDINARY_PRESET || 'croma_uploads';
            const urls = [];
            
            if (uploadProgress) uploadProgress.classList.remove('hidden');
            
            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('file', files[i]);
                formData.append('upload_preset', preset);
                formData.append('folder', 'croma/products');

                const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!res.ok) throw new Error('ERR_MEDIA_UPLOAD_FAILED');
                const data = await res.json();
                urls.push(data.secure_url);
                
                if (progressBar) progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
            }
            return urls;
        }

        // Deployment Logic
        submitBtn?.addEventListener('click', async (e) => {
            e.preventDefault(); // Just in case
            
            // Manual Validation
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            if (isSubmitting) return;
            
            isSubmitting = true;
            if (submitBtn) {
                submitBtn.setAttribute('disabled', 'true');
                submitBtn.innerHTML = '<span class="animate-pulse">SINCRONIZANDO...</span>';
            }

            try {
                // Media Phase
                const imageUrls = await uploadToCloud(selectedFiles);

                // Extraction Phase
                const formData = new FormData(form);
                const name = formData.get('name') as string;
                const price = parseFloat(formData.get('price') as string);
                const category = formData.get('category') as string;
                const brand = formData.get('brand') as string;
                const featured = formData.get('featured') === 'on';
                
                // Tech Specs
                const colors = Array.from(form.querySelectorAll('input[name="product_colors"]:checked'))
                    .map(i => (i as HTMLInputElement).value);

                const stockBySizes: Record<string, number> = {};
                form.querySelectorAll('input[name^="stock_"]').forEach(i => {
                    const el = i as HTMLInputElement;
                    const q = parseInt(el.value) || 0;
                    if (q > 0) stockBySizes[el.name.replace('stock_', '')] = q;
                });

                // Slug Protocol
                const slug = name.toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]+/g, '-') 
                    .replace(/^-+|-+$/g, '');

                // Marketing Fields Extraction
                const islimitedDrop = formData.get('is_limited_drop') === 'on';
                const dropEndDate = formData.get('drop_end_date') ? new Date(formData.get('drop_end_date') as string).toISOString() : null;
                const discountActive = formData.get('discount_active') === 'on';
                const discountPercent = parseInt(formData.get('discount_percent') as string) || 0;
                const discountEndDate = formData.get('discount_end_date') ? new Date(formData.get('discount_end_date') as string).toISOString() : null;
                const launchDate = formData.get('launch_date') ? new Date(formData.get('launch_date') as string).toISOString() : null;
                const isViralTrend = formData.get('is_viral_trend') === 'on';
                const isBestseller = formData.get('is_bestseller') === 'on';
                const isHidden = formData.get('is_hidden') === 'on';

                // RPC Dispatch
                console.log('Dispatching admin_create_product...');
                const { error } = await supabase.rpc('admin_create_product', {
                    p_name: name,
                    p_slug: slug,
                    p_description: formData.get('description') as string,
                    p_price: price,
                    p_category: category,
                    p_brand: brand,
                    p_images: imageUrls,
                    p_stock_by_sizes: stockBySizes,
                    p_featured: featured,
                    p_colors: colors,
                    // Marketing Fields
                    p_is_limited_drop: islimitedDrop,
                    p_drop_end_date: dropEndDate,
                    p_discount_active: discountActive,
                    p_discount_percent: discountPercent,
                    p_discount_end_date: discountEndDate,
                    p_launch_date: launchDate,
                    p_is_viral_trend: isViralTrend,
                    p_is_bestseller: isBestseller,
                    p_is_hidden: isHidden
                });

                if (error) throw error;

                (window as any).showIndustrialAlert('ARTÍCULO DESPLEGADO CON ÉXITO', 'success');
                setTimeout(() => navigate('/admin/products'), 500);
            } catch (err: any) {
                console.error('CRITICAL DEPLOYMENT FAILURE:', err);
                (window as any).showIndustrialAlert('FALLO EN PROTOCOLO DE DESPLIEGUE: ' + (err.message || 'Interrupción de señal'), 'error');
                isSubmitting = false;
                if (submitBtn) {
                    submitBtn.removeAttribute('disabled');
                    submitBtn.innerHTML = '<span class="group-hover:tracking-[0.5em] transition-all">Reintentar Despliegue</span>';
                }
            }
        });
    }

    document.addEventListener('astro:page-load', initPage);
  </script>
</AdminLayout>
