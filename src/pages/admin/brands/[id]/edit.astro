---
import BaseLayout from '@layouts/BaseLayout.astro';
import { supabase } from '../../../../lib/supabase';

const { id } = Astro.params;
const user = Astro.locals.user;
const profile = Astro.locals.profile;

if (!user || profile?.role !== 'admin') {
  return Astro.redirect('/auth/login');
}

const { data: brand, error } = await supabase
  .from('brands')
  .select('*')
  .eq('id', id)
  .single();

if (error || !brand) {
  return Astro.redirect('/admin/brands');
}
---

<BaseLayout title={`Editar ${brand.name}`}>
  <div class="min-h-screen bg-gray-50">
    <header class="bg-white border-b border-gray-200">
      <div class="container-custom py-4">
        <h1 class="text-2xl font-bold text-gray-900">Editar Marca</h1>
      </div>
    </header>

    <main class="container-custom py-8">
      <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 p-8">
        <form id="edit-brand-form" class="space-y-6" data-id={brand.id}>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre</label>
                <input type="text" name="name" value={brand.name} required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Slug</label>
                <input type="text" name="slug" value={brand.slug} required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">URL del Sitio Web</label>
                <input type="url" name="website" value={brand.website} class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">URL del Logo</label>
                <input type="text" name="logo" value={brand.logo} class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black" />
            </div>

            <div class="flex justify-end gap-4 pt-4">
                <a href="/admin/brands" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">Cancelar</a>
                <button type="submit" class="px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800">Guardar Cambios</button>
            </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    import { supabase } from '../../../../lib/supabase';

    const form = document.getElementById('edit-brand-form') as HTMLFormElement;
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const id = form.getAttribute('data-id');
        
        const { error } = await supabase.rpc('admin_update_brand', {
            p_id: id,
            p_name: formData.get('name'),
            p_slug: formData.get('slug'),
            p_logo: formData.get('logo'),
            p_website: formData.get('website')
        });

        if (error) {
            alert('Error: ' + error.message);
        } else {
            alert('Marca actualizada');
            window.location.href = '/admin/brands';
        }
    });
  </script>
</BaseLayout>
