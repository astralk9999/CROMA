---
export const prerender = false;

import BaseLayout from '@layouts/BaseLayout.astro';
import { supabase } from '@lib/supabase';

let error = '';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const email = formData.get('email')?.toString();
    const password = formData.get('password')?.toString();

    if (!email || !password) {
      error = 'Por favor, completa todos los campos.';
    } else {
      const { data, error: authError } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (authError) {
        error = 'Credenciales incorrectas.';
      } else if (data.session) {
        Astro.cookies.set('sb-access-token', data.session.access_token, {
          path: '/',
          httpOnly: true,
          secure: true,
          sameSite: 'lax',
        });
        Astro.cookies.set('sb-refresh-token', data.session.refresh_token, {
          path: '/',
          httpOnly: true,
          secure: true,
          sameSite: 'lax',
        });
        return Astro.redirect('/admin');
      }
    }
  } catch (e) {
    error = 'Error al iniciar sesión. Inténtalo de nuevo.';
  }
}
---

<BaseLayout title="Admin Login">
  <div class="min-h-screen flex items-center justify-center bg-cream-100 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <div>
        <h2 class="text-center text-4xl font-serif font-bold text-navy-900">
          FashionMarket
        </h2>
        <p class="mt-2 text-center text-sm text-charcoal-600">
          Panel de Administración
        </p>
      </div>
      
      <div class="bg-white rounded-lg shadow-lg p-8">
        {error && (
          <div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
            {error}
          </div>
        )}
        
        <form method="POST" class="space-y-6">
          <div>
            <label for="email" class="block text-sm font-medium text-charcoal-700 mb-2">
              Correo Electrónico
            </label>
            <input
              id="email"
              name="email"
              type="email"
              required
              class="w-full px-3 py-2 border border-charcoal-300 rounded-md focus:outline-none focus:ring-2 focus:ring-navy-600"
              placeholder="admin@fashionmarket.com"
            />
          </div>
          
          <div>
            <label for="password" class="block text-sm font-medium text-charcoal-700 mb-2">
              Contraseña
            </label>
            <input
              id="password"
              name="password"
              type="password"
              required
              class="w-full px-3 py-2 border border-charcoal-300 rounded-md focus:outline-none focus:ring-2 focus:ring-navy-600"
              placeholder="••••••••"
            />
          </div>

          <button
            type="submit"
            class="w-full py-3 px-4 bg-navy-800 hover:bg-navy-900 text-white font-semibold rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-navy-600"
          >
            Iniciar Sesión
          </button>
        </form>
      </div>
      
      <p class="text-center text-sm text-charcoal-500">
        <a href="/" class="text-navy-800 hover:underline">
          ← Volver a la tienda
        </a>
      </p>
    </div>
  </div>
</BaseLayout>
