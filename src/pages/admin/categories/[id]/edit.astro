---
import BaseLayout from '@layouts/BaseLayout.astro';
import { supabase } from '../../../../lib/supabase';

const { id } = Astro.params;
const user = Astro.locals.user;
const profile = Astro.locals.profile;

if (!user || profile?.role !== 'admin') {
  return Astro.redirect('/auth/login');
}

const { data: category, error } = await supabase
  .from('categories')
  .select('*')
  .eq('id', id)
  .single();

if (error || !category) {
  return Astro.redirect('/admin/categories');
}
---

<BaseLayout title={`Editar ${category.name}`}>
  <div class="min-h-screen bg-gray-50">
    <header class="bg-white border-b border-gray-200">
      <div class="container-custom py-4">
        <h1 class="text-2xl font-bold text-gray-900">Editar Categoría</h1>
      </div>
    </header>

    <main class="container-custom py-8">
      <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 p-8">
        <form id="edit-category-form" class="space-y-6" data-id={category.id}>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre</label>
                <input type="text" name="name" value={category.name} required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Slug (URL)</label>
                <input type="text" name="slug" value={category.slug} required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Descripción</label>
                <textarea name="description" rows="3" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black">{category.description}</textarea>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">URL de Imagen</label>
                <input type="text" name="image" value={category.image} class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black" />
            </div>

            <div class="flex justify-end gap-4 pt-4">
                <a href="/admin/categories" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">Cancelar</a>
                <button type="submit" class="px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800">Guardar Cambios</button>
            </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    import { supabase } from '../../../../lib/supabase';

    const form = document.getElementById('edit-category-form') as HTMLFormElement;
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const id = form.getAttribute('data-id');
        
        const { error } = await supabase.rpc('admin_update_category', {
            p_id: id,
            p_name: formData.get('name'),
            p_slug: formData.get('slug'),
            p_description: formData.get('description'),
            p_image: formData.get('image')
        });

        if (error) {
            alert('Error: ' + error.message);
        } else {
            alert('Categoría actualizada');
            window.location.href = '/admin/categories';
        }
    });
  </script>
</BaseLayout>
