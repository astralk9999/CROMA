---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

const { data: products } = await supabase
  .from('products')
  .select('*');

const { data: categories } = await supabase
  .from('categories')
  .select('*');

const totalProducts = products?.length || 0;
const totalCategories = categories?.length || 0;
const lowStockProducts = products?.filter(p => p.stock > 0 && p.stock <= 5).length || 0;
const outOfStockProducts = products?.filter(p => p.stock === 0).length || 0;
---

<AdminLayout title="Dashboard">
  <h1 class="text-4xl font-serif font-bold text-navy-900 mb-8">Dashboard</h1>

  {/* Stats Grid */}
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow-sm border border-charcoal-200">
      <p class="text-sm text-charcoal-600 mb-1">Total Productos</p>
      <p class="text-3xl font-bold text-navy-900">{totalProducts}</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-sm border border-charcoal-200">
      <p class="text-sm text-charcoal-600 mb-1">Categorías</p>
      <p class="text-3xl font-bold text-navy-900">{totalCategories}</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-sm border border-charcoal-200">
      <p class="text-sm text-charcoal-600 mb-1">Stock Bajo</p>
      <p class="text-3xl font-bold text-gold-600">{lowStockProducts}</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-sm border border-charcoal-200">
      <p class="text-sm text-charcoal-600 mb-1">Agotados</p>
      <p class="text-3xl font-bold text-red-600">{outOfStockProducts}</p>
    </div>
  </div>

  {/* Recent Products */}
  <div class="bg-white rounded-lg shadow-sm border border-charcoal-200">
    <div class="p-6 border-b border-charcoal-200">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-serif font-semibold text-navy-900">Productos Recientes</h2>
        <a href="/admin/productos/nuevo" class="px-4 py-2 bg-navy-800 text-white rounded hover:bg-navy-900 transition-colors">
          Nuevo Producto
        </a>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-cream-100 border-b border-charcoal-200">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-charcoal-700 uppercase tracking-wider">Producto</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-charcoal-700 uppercase tracking-wider">Categoría</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-charcoal-700 uppercase tracking-wider">Precio</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-charcoal-700 uppercase tracking-wider">Stock</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-charcoal-700 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-charcoal-200">
          {products && products.slice(0, 10).map((product) => (
            <tr class="hover:bg-cream-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="h-10 w-10 flex-shrink-0 bg-cream-200 rounded overflow-hidden">
                    {product.images?.[0] && (
                      <img src={product.images[0]} alt={product.name} class="h-full w-full object-cover" />
                    )}
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-charcoal-900">{product.name}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-charcoal-600">
                {product.category_id || 'Sin categoría'}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-charcoal-900 font-medium">
                €{(product.price / 100).toFixed(2)}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class:list={[
                  'px-2 py-1 text-xs font-medium rounded',
                  product.stock === 0 ? 'bg-red-100 text-red-800' :
                  product.stock <= 5 ? 'bg-gold-100 text-gold-800' :
                  'bg-green-100 text-green-800'
                ]}>
                  {product.stock}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <a href={`/admin/productos/${product.id}`} class="text-navy-800 hover:underline">
                  Editar
                </a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>
</AdminLayout>
