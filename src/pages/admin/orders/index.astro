---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

// Fetch all orders with items
const { data: orders, error } = await supabase
  .from('orders')
  .select(`
    *,
    order_items (
      *,
      product:products (name, images)
    )
  `)
  .order('created_at', { ascending: false });

const statusFilter = Astro.url.searchParams.get('status') || '';

// Filter orders
let filteredOrders = orders || [];
if (statusFilter) {
  filteredOrders = filteredOrders.filter(o => o.status === statusFilter);
}

const statuses = ['pending', 'processing', 'shipped', 'delivered', 'cancelled'];
const statusLabels: Record<string, string> = {
  pending: 'Pendiente',
  processing: 'Procesando',
  shipped: 'Enviado',
  delivered: 'Entregado',
  cancelled: 'Cancelado'
};
---

<AdminLayout title="Gestión de Pedidos" activeSection="orders">
  <!-- Filter Bar -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
    <form method="get" class="flex flex-wrap gap-4 items-center">
      <label class="text-sm font-semibold text-gray-700">Filtrar por estado:</label>
      <select
        name="status"
        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black"
        onchange="this.form.submit()"
      >
        <option value="">Todos los estados</option>
        {statuses.map(status => (
          <option value={status} selected={statusFilter === status}>
            {statusLabels[status]}
          </option>
        ))}
      </select>
      <span class="text-sm text-gray-500">{filteredOrders.length} pedidos</span>
    </form>
  </div>

  <!-- Orders List -->
  <div class="space-y-4">
    {filteredOrders.length > 0 ? (
      filteredOrders.map(order => (
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="text-lg font-bold text-gray-900">Pedido #{order.id.slice(0, 8)}</h3>
                <p class="text-sm text-gray-500">
                  {new Date(order.created_at).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                </p>
              </div>
              <div class="flex items-center gap-4">
                <span class="text-lg font-bold text-gray-900">
                  {Number(order.total_amount).toFixed(2)}€
                </span>
                <select
                  data-order-id={order.id}
                  class="status-select px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black font-medium"
                >
                  {statuses.map(status => (
                    <option value={status} selected={order.status === status}>
                      {statusLabels[status]}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <!-- Order Items -->
            <div class="border-t border-gray-200 pt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">Productos ({order.order_items?.length || 0})</h4>
              <div class="space-y-2">
                {order.order_items?.map((item: any) => (
                  <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                    {item.product?.images?.[0] ? (
                      <img
                        src={item.product.images[0]}
                        alt={item.product_name}
                        class="w-16 h-16 object-cover rounded-lg"
                      />
                    ) : (
                      <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                      </div>
                    )}
                    <div class="flex-1">
                      <p class="font-medium text-gray-900">{item.product_name}</p>
                      <p class="text-sm text-gray-600">Talla: {item.size} | Cantidad: {item.quantity}</p>
                    </div>
                    <p class="font-medium text-gray-900">{Number(item.price).toFixed(2)}€</p>
                  </div>
                ))}
              </div>
            </div>

            <!-- Shipping Address -->
            <div class="border-t border-gray-200 mt-4 pt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-2">Dirección de Envío</h4>
              <div class="text-sm text-gray-600">
                {order.shipping_address && typeof order.shipping_address === 'object' && (
                  <>
                    <p>{order.shipping_address.name}</p>
                    <p>{order.shipping_address.address}</p>
                    <p>{order.shipping_address.city}, {order.shipping_address.postal_code}</p>
                    <p>{order.shipping_address.country}</p>
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      ))
    ) : (
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
        <svg class="mx-auto w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
        </svg>
        <p class="text-gray-500">No hay pedidos todavía</p>
      </div>
    )}
  </div>

  <script>
    import { supabase } from '../../../lib/supabase';

    // Handle status change
    const statusSelects = document.querySelectorAll('.status-select');
    
    statusSelects.forEach(select => {
      select.addEventListener('change', async (e) => {
        const orderId = (e.target as HTMLSelectElement).dataset.orderId;
        const newStatus = (e.target as HTMLSelectElement).value;
        
        if (!confirm(`¿Cambiar el estado del pedido a "${newStatus}"?`)) {
          // Revert selection
          window.location.reload();
          return;
        }

        try {
          const { error } = await supabase
            .from('orders')
            .update({ status: newStatus })
            .eq('id', orderId);

          if (error) throw error;

          alert('Estado del pedido actualizado exitosamente');
          window.location.reload();
        } catch (error: any) {
          console.error('Error updating order status:', error);
          alert('Error al actualizar el estado: ' + error.message);
          window.location.reload();
        }
      });
    });
  </script>
</AdminLayout>
