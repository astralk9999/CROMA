---
import BaseLayout from '@layouts/BaseLayout.astro';
import { supabase } from '../../../lib/supabase';

const user = Astro.locals.user;
const profile = Astro.locals.profile;

if (!user || profile?.role !== 'admin') {
  return Astro.redirect('/auth/login');
}
---

<BaseLayout title="Nueva Categoría">
  <div class="min-h-screen bg-gray-50">
    <header class="bg-white border-b border-gray-200">
      <div class="container-custom py-4">
        <h1 class="text-2xl font-bold text-gray-900">Nueva Categoría</h1>
      </div>
    </header>

    <main class="container-custom py-8">
      <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 p-8">
        <form id="create-category-form" class="space-y-6">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre</label>
                <input type="text" name="name" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Slug (URL)</label>
                <input type="text" name="slug" required placeholder="ej: camisetas-hombre" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Descripción</label>
                <textarea name="description" rows="3" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black"></textarea>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">URL de Imagen (Opcional)</label>
                <input type="text" name="image" placeholder="https://..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black" />
            </div>

            <div class="flex justify-end gap-4 pt-4">
                <a href="/admin/categories" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">Cancelar</a>
                <button type="submit" class="px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800">Crear Categoría</button>
            </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    import { supabase } from '../../../lib/supabase';

    const form = document.getElementById('create-category-form') as HTMLFormElement;
    
    // Auto-generate slug
    const nameInput = form.querySelector('input[name="name"]') as HTMLInputElement;
    const slugInput = form.querySelector('input[name="slug"]') as HTMLInputElement;

    nameInput.addEventListener('input', () => {
        const slug = nameInput.value.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-') 
            .replace(/^-+|-+$/g, '');
        slugInput.value = slug;
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        
        const { error } = await supabase.rpc('admin_create_category', {
            p_name: formData.get('name'),
            p_slug: formData.get('slug'),
            p_description: formData.get('description'),
            p_image: formData.get('image')
        });

        if (error) {
            alert('Error: ' + error.message);
        } else {
            window.location.href = '/admin/categories';
        }
    });
  </script>
</BaseLayout>
