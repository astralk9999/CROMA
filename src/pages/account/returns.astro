---
import PublicLayout from '@layouts/PublicLayout.astro';
import { supabaseAdmin } from '@lib/supabase-admin';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/auth/login?redirect=/account/returns');
}

// Fetch return requests for this user
const { data: returns } = await supabaseAdmin
  .from('return_requests')
  .select(`
    *,
    orders (id, total_amount, created_at),
    return_request_items (
        quantity,
        order_items (
            product_name,
            size,
            product_image
        )
    )
  `)
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });

const statusLabels: Record<string, string> = {
  pending: 'Pendiente de Revisión',
  approved: 'Aprobada - En Proceso',
  rejected: 'Rechazada',
  completed: 'Finalizada'
};

const formatDate = (date: string) => new Date(date).toLocaleDateString('es-ES', { 
    day: 'numeric', month: 'long', year: 'numeric' 
});
---

<PublicLayout title="Mis Devoluciones">
  <section class="container-custom py-24 min-h-screen bg-white">
    <div class="max-w-6xl mx-auto px-4 md:px-0">
      {/* Mega Header Section */}
      <div class="flex flex-col mb-24 gap-8">
          <div class="flex items-center gap-4">
              <span class="w-16 h-0.5 bg-zinc-400"></span>
              <span class="text-xs font-bold uppercase tracking-[0.5em] text-zinc-500">Audit_Terminal.Returns</span>
          </div>
          
          <h1 class="text-6xl md:text-8xl lg:text-9xl font-urban font-black text-zinc-900 tracking-tighter uppercase leading-[0.8] italic">
              MIS <span class="text-zinc-400">RETORNOS</span>
          </h1>

          <div class="flex flex-col md:flex-row md:items-end justify-between gap-8 border-b border-zinc-300 pb-12">
              <div class="max-w-2xl">
                  <p class="text-zinc-600 font-bold text-lg md:text-xl uppercase tracking-tight leading-snug">
                      Monitorización de protocolos de devolución, garantías técnicas y auditoría de calidad post-venta.
                  </p>
              </div>
              <a href="/account/orders" class="group flex items-center gap-3 text-sm font-bold uppercase tracking-[0.2em] text-zinc-600 hover:text-zinc-900 transition-all px-8 py-4 border border-zinc-300 rounded-full hover:bg-zinc-50 hover:shadow-xl hover:shadow-zinc-200/50">
                  <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16l-4-4m0 0l4-4m-4 4h18"/></svg>
                  VOLVER A PEDIDOS
              </a>
          </div>
      </div>

      {!returns || returns.length === 0 ? (
        <div class="bg-white rounded-[3rem] border border-zinc-300 p-24 text-center shadow-2xl shadow-zinc-200/40 relative overflow-hidden group">
             <div class="w-24 h-24 bg-zinc-100 rounded-full flex items-center justify-center mx-auto mb-10 text-zinc-300">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3m9 14V5a2 2 0 00-2-2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2z" /></svg>
             </div>
             <h2 class="text-5xl font-urban font-black text-zinc-900 mb-6 uppercase italic">SIN PROTOCOLOS</h2>
             <p class="text-zinc-500 font-bold uppercase tracking-[0.2em] mb-12">No se han detectado tickets de devolución activos en la red.</p>
             <a href="/account/orders" class="inline-block px-12 py-5 bg-zinc-900 text-white text-md font-bold uppercase tracking-widest rounded-full hover:bg-black transition-all shadow-xl hover:shadow-2xl">
                VER HISTORIAL DE PEDIDOS
             </a>
        </div>
      ) : (
        <div class="space-y-32">
            <div class="flex items-center gap-6 mb-12 font-urban opacity-80">
                <h2 class="text-2xl font-black text-zinc-800 uppercase tracking-[0.3em] italic">ACTIVE_AUDITS</h2>
                <div class="h-px flex-1 bg-zinc-300"></div>
                <span class="text-zinc-500 font-bold uppercase tracking-widest text-xs">{returns.length} TICKETS</span>
            </div>

            <div class="grid gap-20">
                {returns.map(ret => (
                    <article class="bg-white rounded-[3rem] border border-zinc-300 shadow-2xl shadow-zinc-200/40 overflow-hidden transition-all duration-700">
                        {/* Header Section */}
                        <div class="bg-zinc-900 py-8 px-10 flex flex-wrap items-center justify-between gap-8 relative overflow-hidden">
                             {/* Large Status Decal */}
                             <div class="absolute top-0 right-0 h-full flex items-center opacity-5 pointer-events-none translate-x-4">
                                 <span class="text-8xl font-urban font-black italic tracking-tighter text-white uppercase">{ret.status}</span>
                             </div>

                            <div class="flex gap-12 relative z-10">
                                <div class="flex flex-col">
                                    <p class="text-zinc-500 font-bold text-[9px] uppercase tracking-[0.4em] mb-1">TICKET_ID</p>
                                    <p class="font-mono text-white text-sm font-bold tracking-tighter">#{ret.id.slice(0, 16).toUpperCase()}</p>
                                </div>
                                <div class="hidden md:flex flex-col border-l border-white/10 pl-12">
                                    <p class="text-zinc-500 font-bold text-[9px] uppercase tracking-[0.4em] mb-1">AUDIT_DATE</p>
                                    <p class="font-bold text-white text-sm uppercase">{formatDate(ret.created_at)}</p>
                                </div>
                            </div>
                            
                            <div class="relative z-10">
                                <span class={`px-8 py-3 text-sm font-bold uppercase tracking-[0.2em] rounded-full shadow-lg shadow-zinc-950/20 ${
                                    ret.status === 'pending' ? 'bg-amber-400 text-amber-950' :
                                    ret.status === 'approved' ? 'bg-emerald-400 text-emerald-950' :
                                    ret.status === 'rejected' ? 'bg-red-500 text-white' :
                                    'bg-zinc-700 text-white'
                                }`}>
                                    {statusLabels[ret.status].toUpperCase()}
                                </span>
                            </div>
                        </div>

                        {/* Body Section */}
                        <div class="p-10 md:p-16">
                            <div class="grid lg:grid-cols-[1fr_360px] gap-16 md:gap-24">
                                <div class="space-y-16">
                                    <div>
                                        <div class="flex items-center gap-4 mb-8">
                                            <div class="w-10 h-10 bg-zinc-900 rounded-xl flex items-center justify-center text-white font-urban font-black italic">!</div>
                                            <h3 class="text-3xl md:text-5xl font-urban font-black text-zinc-900 uppercase italic tracking-tighter">{ret.reason}</h3>
                                        </div>
                                        
                                        <div class="p-10 bg-zinc-50 border border-zinc-300 rounded-[2.5rem] relative overflow-hidden group/details hover:bg-white hover:shadow-xl hover:shadow-zinc-200/50 transition-all duration-500">
                                            <div class="absolute top-0 right-0 p-8 opacity-[0.05] group-hover/details:rotate-12 transition-transform">
                                                <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                            </div>
                                            <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-[0.5em] mb-6 border-b border-zinc-200 pb-4">DECLARACIÓN_AUDITADA</p>
                                            <p class="text-xl text-zinc-800 leading-relaxed italic font-bold">"{ret.details || 'SIN_OBSERVACIONES_ADICIONALES.'}"</p>
                                        </div>
                                    </div>

                                    <div>
                                        <h4 class="text-xs font-bold text-zinc-500 uppercase tracking-[0.4em] mb-8 flex items-center gap-3">
                                            <span class="w-8 h-px bg-zinc-300"></span>
                                            ARTÍCULOS PROTOCOLADOS:
                                        </h4>
                                        <div class="grid gap-6">
                                            {ret.return_request_items?.map((item: any) => (
                                                <div class="flex items-center gap-8 p-6 rounded-3xl bg-white border border-zinc-200 hover:border-zinc-400 hover:shadow-xl hover:shadow-zinc-200/50 transition-all duration-500 group/item">
                                                    <div class="w-24 h-24 bg-zinc-50 border border-zinc-200 rounded-2xl group-hover/item:shadow-lg transition-all overflow-hidden flex-shrink-0">
                                                        <img src={item.order_items[0].product_image} class="w-full h-full object-cover grayscale group-hover/item:grayscale-0 transition-all duration-700" />
                                                    </div>
                                                    <div class="space-y-3">
                                                        <p class="text-2xl font-urban font-black uppercase italic text-zinc-900 tracking-tight">{item.order_items[0].product_name}</p>
                                                        <div class="flex items-center gap-4">
                                                            <span class="px-3 py-1 bg-zinc-100 text-zinc-600 text-[10px] font-bold uppercase tracking-widest rounded-lg">SIZE_{item.order_items[0].size}</span>
                                                            <span class="text-zinc-400 text-[10px] font-bold uppercase tracking-widest">CANTIDAD: {item.quantity}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Right Sidebar */}
                                <div class="space-y-16">
                                    {ret.images?.length > 0 && (
                                        <div class="space-y-8">
                                            <h4 class="text-xs font-bold text-zinc-500 uppercase tracking-[0.4em] px-2 flex items-center justify-between">
                                                EVIDENCIA_VISUAL <span class="opacity-30">[{ret.images.length}]</span>
                                            </h4>
                                            <div class="grid grid-cols-2 gap-6">
                                                {ret.images.map((img: string) => (
                                                    <a href={img} target="_blank" class="block aspect-square border border-zinc-300 rounded-2xl hover:shadow-2xl hover:shadow-zinc-300 transition-all overflow-hidden bg-white p-2">
                                                        <img src={img} class="w-full h-full object-cover rounded-xl grayscale hover:grayscale-0 transition-all duration-700" />
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div class="p-10 bg-zinc-900 rounded-[2.5rem] shadow-2xl shadow-zinc-900/10 text-white relative overflow-hidden group/pod">
                                        <div class="absolute top-0 right-0 p-8 opacity-5 pointer-events-none group-hover/pod:scale-110 transition-transform">
                                            <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 24 24"><path d="M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>
                                        </div>
                                        <p class="text-zinc-500 font-bold text-[10px] uppercase tracking-[0.5em] mb-8 font-mono">SUPPORT_DATA</p>
                                        <div class="space-y-4">
                                            <div class="flex justify-between items-center text-xs font-bold text-zinc-400 uppercase tracking-tight">
                                                <span class="tracking-[0.2em]">ORIGIN_ORDER</span>
                                                <span class="font-mono text-white">#{ret.order_id.slice(0, 12).toUpperCase()}</span>
                                            </div>
                                            <div class="flex justify-between items-center text-xs font-bold text-zinc-400 uppercase tracking-tight">
                                                <span class="tracking-[0.2em]">TOTAL_AMOUNT</span>
                                                <span class="text-white">{Number(ret.orders?.total_amount).toFixed(2)}€</span>
                                            </div>
                                            <div class="flex justify-between items-center text-xs font-bold text-zinc-400 uppercase tracking-tight">
                                                <span class="tracking-[0.2em]">RETURNED_UNITS</span>
                                                <span class="text-white">{ret.return_request_items?.length} UNID</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {ret.admin_notes && (
                                <div class="mt-20 p-12 bg-zinc-900 text-white rounded-[2.5rem] relative overflow-hidden group/admin border-l-8 border-red-500">
                                    <div class="absolute top-0 right-0 p-10 opacity-[0.05] translate-x-4 group-hover/admin:translate-x-0 transition-transform">
                                        <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                                    </div>
                                    <div class="relative z-10">
                                        <div class="flex items-center gap-4 mb-6">
                                            <span class="w-8 h-px bg-white/20"></span>
                                            <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-[0.5em]">ADMIN.RESPONSE_REPORT</p>
                                        </div>
                                        <p class="text-xl font-bold italic leading-relaxed text-zinc-100">"{ret.admin_notes}"</p>
                                    </div>
                                </div>
                            )}

                            <div class="mt-24 pt-12 border-t border-zinc-100 flex flex-wrap items-center justify-between gap-8">
                                <div class="flex items-center gap-6">
                                    <div class="flex items-center gap-3">
                                        <div class={`w-2 h-2 rounded-full ${ret.status === 'pending' ? 'bg-amber-400 animate-pulse' : 'bg-emerald-400'}`}></div>
                                        <span class="text-[10px] font-bold text-zinc-900 uppercase tracking-[0.3em] font-mono">
                                            SYST_LOCK: {ret.status === 'pending' ? 'WAITING_CONTROL_SYNC' : 'LOG_LOCKED'}
                                        </span>
                                    </div>
                                    <div class="w-px h-6 bg-zinc-100"></div>
                                    <p class="text-[10px] font-bold text-zinc-300 uppercase tracking-[0.5em] font-mono italic">CROMA_SECURE_v4.4</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="w-12 h-px bg-zinc-100"></span>
                                    <span class="text-[8px] font-bold text-zinc-200 uppercase tracking-widest font-mono italic">END_OF_RECORD</span>
                                </div>
                            </div>
                        </div>
                    </article>
                ))}
            </div>
        </div>
      )}
    </div>
  </section>
</PublicLayout>
