---
import PublicLayout from '@layouts/PublicLayout.astro';
import ProductCard from '@components/product/ProductCard.astro';
import Sidebar from '@components/Sidebar.astro';
import FavoritesGrid from '@components/islands/FavoritesGrid';
import ProductGrid from '@components/islands/ProductGrid';
import { supabase } from '@lib/supabase';

const { slug } = Astro.params;

// Normalize slug to handle double dashes or other variations
const normalizedSlug = slug?.replace(/--+/g, '-') || slug || 'all';

// Default name (will be updated if found in DB)
let name = (normalizedSlug || 'COLLECTION').replace(/-/g, ' ').toUpperCase();

// Check if user is authenticated
const user = Astro.locals.user;

// Fetch all products from Supabase
// Note: Optimally we would filter in SQL, but for mixed logic (viral, legacy sales, favorites), fetching all is safer for now.
let { data: dbProducts } = await supabase
  .from('products')
  .select('*')
  .order('created_at', { ascending: false });

const dbProductsSafe = dbProducts || [];

// Create products map from DB
const productsMap = new Map<string, any>();

// Add DB products
dbProductsSafe.forEach(p => {
  if (!productsMap.has(p.slug)) productsMap.set(p.slug, p);
});

// Convert back to array
const allProducts = Array.from(productsMap.values());

let filteredProducts: any[] = [];
let showLoginPrompt = false;

// Special Filtering Logic
if (normalizedSlug === 'all') {
  filteredProducts = allProducts;
} else if (normalizedSlug === 'viral-trends') {
  filteredProducts = allProducts.filter((p: any) => p.is_viral_trend === true);
} else if (normalizedSlug === 'sale' || normalizedSlug === 'discounts' || normalizedSlug === 'rebajas') {
  filteredProducts = allProducts.filter((p: any) => p.discount_active === true || (p.sale_price && p.sale_price < p.price));
} else if (normalizedSlug === 'bestsellers') {
  filteredProducts = allProducts.filter((p: any) => p.is_bestseller === true);
} else if (normalizedSlug === 'limited-drops') {
  filteredProducts = allProducts.filter((p: any) => p.is_limited_drop === true);
} else if (normalizedSlug === 'coming-soon') {
   const now = new Date();
   filteredProducts = allProducts.filter((p: any) => p.launch_date && new Date(p.launch_date) > now);
} else if (normalizedSlug === 'my-favorites') {
   if (!user) {
     showLoginPrompt = true;
     filteredProducts = [];
   } else {
     filteredProducts = [];
   }
} else {
  // Dynamic Category Lookup
  // 1. Try to find the category in the DB by slug to get its exact Name
  const { data: categoryData } = await supabase
    .from('categories')
    .select('name')
    .eq('slug', normalizedSlug)
    .single();

  if (categoryData) {
      // If found, filter by the proper name (e.g. "CHAQUETAS")
      name = categoryData.name.toUpperCase();
      filteredProducts = allProducts.filter((p: any) => p.category === categoryData.name);
  } else {
      // Fallback: try matching loosely or normalized
      // This handles cases where maybe the URL slug matches the category name directly (legacy)
      filteredProducts = allProducts.filter((p: any) => 
        p.category === normalizedSlug || 
        p.category?.toLowerCase() === normalizedSlug.replace(/-/g, ' ')
      );
  }
}

// Fetch all available colors for filtering
const { data: colors } = await supabase
  .from('colors')
  .select('*')
  .order('name');
---

<PublicLayout title={name}>
  <section class="container-custom py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      {/* Sidebar */}
      <Sidebar />

      {/* Main Content */}
      <div class="flex-1">
        
        {/* Login Prompt for My Favorites */}
        {showLoginPrompt && (
          <div class="flex flex-col items-center justify-center py-20 min-h-[50vh]">
            <div class="text-center max-w-lg mx-auto">
                <svg class="w-16 h-16 mx-auto mb-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
                <h2 class="text-2xl font-black text-gray-900 mb-3 uppercase tracking-tight condensed">INICIA SESIÓN PARA VER TUS FAVORITOS</h2>
                <p class="text-gray-500 mb-8 font-medium">Guarda tus productos favoritos y accede a ellos en cualquier momento.</p>
                <a href="/auth/login" class="inline-block bg-black text-white px-10 py-4 rounded-lg hover:bg-gray-800 transition-all font-black uppercase tracking-widest text-sm">
                    Iniciar sesión
                </a>
            </div>
          </div>
        )}

        {/* Favorites - Client Side Rendering */}
        {normalizedSlug === 'my-favorites' && user && (
          <FavoritesGrid client:load allProducts={allProducts} />
        )}

        {/* Products Grid - React Island with Filters */}
        {!showLoginPrompt && normalizedSlug !== 'my-favorites' && (
          <div class="min-h-[50vh]">
            {filteredProducts && filteredProducts.length > 0 ? (
              <ProductGrid 
                client:load 
                products={filteredProducts} 
                categoryName={name}
                description={normalizedSlug === 'my-favorites' ? 'Browse our latest collection of my favorites.' : `Browse our latest collection of ${name.toLowerCase()}.`}
                isFavoritesPage={normalizedSlug === 'my-favorites'}
                availableColors={colors || []}
              />
            ) : (
              <div class="text-center py-20">
                <p class="text-xl text-gray-500">No products found for this category.</p>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  </section>
</PublicLayout>
