---
import { supabaseAdmin } from '../lib/supabase-admin';

const serviceKey = import.meta.env.SUPABASE_SERVICE_ROLE_KEY;
let insertResult = null;
let insertError = null;

// Try to insert a test record if we have an order
try {
    // 1. Get an order to reference
    const { data: order } = await supabaseAdmin
        .from('orders')
        .select('id, user_id')
        .eq('status', 'delivered') // Must be delivered? schema says nothing, but logic does. FK is just ID.
        .limit(1)
        .single();

    if (order) {
        // 2. Try insert
        const { data, error } = await supabaseAdmin
            .from('return_requests')
            .insert({
                order_id: order.id,
                user_id: order.user_id,
                reason: 'DEBUG_TEST',
                details: 'Generated by debug script',
                status: 'pending'
            })
            .select()
            .single();

        insertResult = data;
        insertError = error;
    } else {
        insertError = { message: 'No orders found to test with' };
    }

} catch (e: any) {
    insertError = e;
}

// Check existing
const { count, data } = await supabaseAdmin.from('return_requests').select('*', { count: 'exact' });
---

<html>
<body>
    <h1>Debug Returns (Public + Write Test)</h1>
    <div style="border: 1px solid #ccc; padding: 20px; margin: 20px;">
        <h3>Write Test Result</h3>
        {insertResult ? (
            <p style="color: green;">SUCCESS! Inserted ID: {insertResult.id}</p>
        ) : (
            <p style="color: red;">FAILED! Error: {JSON.stringify(insertError, null, 2)}</p>
        )}
    </div>

    <div style="border: 1px solid #ccc; padding: 20px; margin: 20px;">
        <h3>Table Data ({count} rows)</h3>
        <pre>{JSON.stringify(data, null, 2)}</pre>
    </div>
</body>
</html>
