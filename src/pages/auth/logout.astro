---
import PublicLayout from '@layouts/PublicLayout.astro';
import BrandLogo from '@components/BrandLogo.astro';
import { supabase } from '@lib/supabase';

// Clear session cookies on server
const { cookies } = Astro;
cookies.delete('sb-access-token', { path: '/' });
cookies.delete('sb-refresh-token', { path: '/' });
---

<PublicLayout title="Cerrando Sesión - CROMA">
    <section class="min-h-[80vh] flex items-center justify-center bg-white py-12 px-4">
        <div class="max-w-md w-full text-center">
            <!-- Premium Loading Animation -->
            <div class="relative w-24 h-24 mx-auto mb-8">
                <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-black rounded-full animate-spin border-t-transparent shadow-lg"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <BrandLogo class="w-12 h-12 text-black" />
                </div>
            </div>

            <h1 class="text-3xl font-black uppercase tracking-tighter text-gray-900 mb-4 animate-pulse">
                Cerrando sesión
            </h1>
            
            <div class="space-y-3">
                <p class="text-gray-500 font-medium">Limpiando tu sesión de forma segura...</p>
                <div class="flex justify-center gap-1">
                    <div class="w-1.5 h-1.5 bg-black rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-1.5 h-1.5 bg-black rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-1.5 h-1.5 bg-black rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        import { supabase } from '@lib/supabase';
        
        async function performLogout() {
            // Safety timeout to ensure we ALWAYS redirect within 3 seconds
            const safetyTimeout = setTimeout(() => {
                window.location.href = '/?logout=timeout';
            }, 3000);

            try {
                // 1. Explicitly clear cookies in JS as well
                document.cookie = 'sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';
                document.cookie = 'sb-refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';

                // 2. Clear Application Data
                localStorage.removeItem('croma-favorites');
                
                // 3. Clear Supabase Local Session
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('sb-') || key.includes('supabase.auth.token'))) {
                        localStorage.removeItem(key);
                    }
                }

                // 4. Attempt formal signout
                await supabase.auth.signOut();
            } catch (err) {
                console.warn("Logout cleanup warning:", err);
            } finally {
                clearTimeout(safetyTimeout);
                // 5. Force hard redirect to home
                window.location.href = '/';
            }
        }
        
        // Execute immediately and on astro:page-load
        performLogout();
        document.addEventListener('astro:page-load', () => {
            if (window.location.pathname === '/auth/logout') {
                performLogout();
            }
        });
    </script>
</PublicLayout>
